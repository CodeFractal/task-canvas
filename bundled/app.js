"use strict";(()=>{var ne=class{constructor(e){this.map=new Map;if(e)for(let[t,n,s]of e)this.set(t,n,s)}set(e,t,n){let s=this.map.get(e);s||(s=new Map,this.map.set(e,s)),s.set(t,n)}get(e,t){let n=this.map.get(e);return n?n.get(t):void 0}delete(e,t){let n=this.map.get(e),s=!1;return n&&(s=n.delete(t),n.size===0&&this.map.delete(e)),s}has(e,t){let n=this.map.get(e);return n?n.has(t):!1}clear(){this.map.clear()}getKeys1(){return this.map.keys()}getKeys2(e){let t=this.map.get(e);return t?t.keys():[].values()}getValues(){let e=[];for(let t of this.map.values())for(let n of t.values())e.push(n);return e.values()}getEntries(){let e=[];for(let[t,n]of this.map)for(let[s,o]of n)e.push([t,s,o]);return e.values()}};var k=class i{constructor(e,t){this.x=e;this.y=t}static{this.zero=new i(0,0)}static{this.identity=new i(1,1)}static{this.up=new i(0,-1)}static{this.down=new i(0,1)}static{this.left=new i(-1,0)}static{this.right=new i(1,0)}lenSqr(){return this.x*this.x+this.y*this.y}add(e){return new i(this.x+e.x,this.y+e.y)}sub(e){return new i(this.x-e.x,this.y-e.y)}mul(e){return new i(this.x*e,this.y*e)}div(e){return new i(this.x/e,this.y/e)}translate(e,t){return new i(this.x+e,this.y+t)}negate(){return new i(-this.x,-this.y)}normalize(){let e=this.lenSqr();if(e===0)return i.zero;let t=1/Math.sqrt(e);return new i(this.x*t,this.y*t)}dot(e){return this.x*e.x+this.y*e.y}},P=class i{constructor(e,t){this.position=e;this.size=t}static fromBounds(e){return new i(new k(e.left,e.top),new k(e.right-e.left,e.bottom-e.top))}static fromPoints(e,t){return new i(new k(Math.min(e.x,t.x),Math.min(e.y,t.y)),new k(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}get left(){return this.position.x}get right(){return this.position.x+this.size.x}get top(){return this.position.y}get bottom(){return this.position.y+this.size.y}get width(){return this.size.x}get height(){return this.size.y}scale(e,t){return new i(this.position.sub(t).mul(e).add(t),this.size.mul(e))}contains(e){return e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom}intersects(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}};var E=class{static{this.minScale=.25}static{this.maxScale=2}static{this.canvas=null}static{this.scale=1}static{this.translation=k.zero}static init(e){this.canvas=e,this.canvas.style.transformOrigin="0 0",this.canvas.style.cursor="default",this.updateTransform(),(this.canvas.parentElement||this.canvas).addEventListener("wheel",t=>this.onWheel(t),{passive:!1})}static updateTransform(){this.canvas&&(this.canvas.style.transform=`translate(${this.translation.x}px, ${this.translation.y}px) scale(${this.scale})`)}static onWheel(e){if(e.preventDefault(),e.ctrlKey){let t=e.deltaY<0?.1:-.1,n=new k(e.clientX,e.clientY);this.setScale(this.scale+t,n)}else{let t=new k(e.deltaX,e.deltaY);this.translation=this.translation.sub(t),this.updateTransform()}}static setScale(e,t){if(e=Math.max(this.minScale,Math.min(this.maxScale,e)),e!==this.scale&&this.canvas){let n=e/this.scale;this.translation=this.translation.mul(n).add(t.mul(1-n)),this.scale=e,this.updateTransform()}}static panBy(e){this.translation=this.translation.add(e),this.updateTransform()}static getScale(){return this.scale}static getTranslation(){return this.translation}};var B=class i{constructor(e){this.vec=e}static new(e,t){return new i(new k(e,t))}static fromEvent(e){return i.new(e.clientX,e.clientY)}static{this.zero=new i(k.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}subtractCoords(e){return new O(this.vec.sub(e.vec))}toCanvasCoords(){let e=E.getScale(),t=E.getTranslation();return y.new((this.x-t.x)/e,(this.y-t.y)/e)}},O=class i{constructor(e){this.vec=e}static new(e,t){return new i(new k(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}toCanvasSize(){let e=E.getScale?E.getScale():1;return new _(this.vec.div(e))}},N=class i{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new P(e.vec,t.vec)}static fromElementBounds(e){let t=e.getBoundingClientRect();return new i(B.new(t.left,t.top),O.new(t.width,t.height))}static fromPoints(e,t){return new i(B.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),O.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toCanvasRect(){return new he(this.position.toCanvasCoords(),this.size.toCanvasSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}},y=class i{constructor(e){this.vec=e}static new(e,t){return new i(new k(e,t))}static{this.zero=new i(k.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}subtractCoords(e){return new _(this.vec.sub(e.vec))}toScreenCoords(){let e=E.getScale?E.getScale():1,t=E.getTranslation();return B.new(this.x*e+t.x,this.y*e+t.y)}},_=class i{constructor(e){this.vec=e}static new(e,t){return new i(new k(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}toScreenSize(){let e=E.getScale?E.getScale():1;return new O(this.vec.mul(e))}},he=class i{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new P(e.vec,t.vec)}static fromPoints(e,t){return new i(y.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),_.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toScreenRect(){return new N(this.position.toScreenCoords(),this.size.toScreenSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}};var x=class i{constructor(e={}){this.requiredDependencies=new Map;this.requiredByDependencies=new Map;e.id&&(i.taskIdCounter=Math.max(i.taskIdCounter,e.id+1)),this.id=e.id||i.taskIdCounter++,this.title=e.title||"New Task",this.description=e.description||"<p>Description</p>",this.position=e.position||null,this.completed=e.completed||!1,this.collapsed=e.collapsed||!1}static{this.taskIdCounter=1}getId(){return this.id}getTitle(){return this.title}getDescription(){return this.description}isComplete(){return this.completed}getRequired(){return this.requiredDependencies}getRequiredBy(){return this.requiredByDependencies}getPosition(){return this.position}isExpanded(){return!this.collapsed}toStorageModel(){if(!this.position)throw new Error("Task must have a position to be saved");return{id:this.id,title:this.title,description:this.description,completed:this.completed,position:this.position,collapsed:this.collapsed}}};var L=class{constructor(e,t){this.requiredTask=e;this.requiredByTask=t}getRequiredTask(){return this.requiredTask}getRequiredByTask(){return this.requiredByTask}toStorageModel(){return{requiredTaskId:this.requiredTask.getId(),requiredByTaskId:this.requiredByTask.getId()}}};var D=new Map,G=new ne;var se=class{constructor(e,t){this.presenter=e;this.storageConnectionProviders=t;this.storageProvider=null;this.canvasIsPaused=!1}isCanvasPaused(){return this.canvasIsPaused}createTask(e){let t=new x({position:e});return D.set(t.id,t),this.presenter.addTaskToCanvas(t),this.pushUndo({type:"addTask",task:t}),this.saveToStorage(t),t}toggleTaskCompletion(e,t){let n=e instanceof x?e:D.get(e.getId());if(!n)throw new Error("Task does not exist");n.completed=t===null?!n.completed:t,this.presenter.toggleTaskCompletion(n,n.completed),this.pushUndo({type:"toggleComplete",taskId:n.id,newValue:n.completed,oldValue:!n.completed}),this.saveToStorage(n)}toggleTaskExpansion(e,t){let n=e instanceof x?e:D.get(e.getId());if(!n)throw new Error("Task does not exist");n.collapsed=t===null?!n.collapsed:!t,this.presenter.toggleTaskExpansion(n,n.collapsed),this.pushUndo({type:"toggleCollapse",taskId:n.id,newValue:n.collapsed,oldValue:!n.collapsed}),this.saveToStorage(n)}changeTaskTitle(e,t){let n=e instanceof x?e:D.get(e.getId());if(!n)throw new Error("Task does not exist");let s=n.title;n.title=t,this.presenter.setTaskTitle(n,t),this.pushUndo({type:"editTask",taskId:n.id,field:"title",newTitle:t,oldTitle:s}),this.saveToStorage(n)}changeTaskDescription(e,t){let n=e instanceof x?e:D.get(e.getId());if(!n)throw new Error("Task does not exist");let s=n.description;n.description=t,this.presenter.setTaskDescription(n,t),this.pushUndo({type:"editTask",taskId:n.id,field:"description",newDescription:t,oldDescription:s}),this.saveToStorage(n)}moveTasks(e){let t=[],n=[];e.forEach(s=>{let{task:o,position:r}=s,a=o instanceof x?o:D.get(o.getId());if(!a)throw new Error("Task does not exist");let d=a.getPosition()||y.zero;a.position=r,this.presenter.moveTask(a,r),a.requiredByDependencies.forEach(h=>{let f=h instanceof L?h:G.get(h.getRequiredTask().getId(),h.getRequiredByTask().getId());f?.arrow&&this.presenter.updateArrow(f.arrow)}),a.requiredDependencies.forEach(h=>{let f=h instanceof L?h:G.get(h.getRequiredTask().getId(),h.getRequiredByTask().getId());f?.arrow&&this.presenter.updateArrow(f.arrow)}),t.push({taskId:a.getId(),oldPosition:d,newPosition:r}),n.push(a)}),this.pushUndo({type:"moveTasks",taskMovements:t}),this.saveToStorage(n)}deleteTasks(e){let t=e.map(o=>{let r=o instanceof x?o:D.get(o.getId());if(!r)throw new Error("Task does not exist");return r}),n=new Set,s=new Set;for(let o of t)this.presenter.removeTask(o),D.delete(o.getId()),n.add(o),o.requiredByDependencies.forEach(r=>{let a=r instanceof L?r:G.get(r.getRequiredTask().getId(),r.getRequiredByTask().getId());!a||s.has(a)||(this.deleteDependency(a,!1,!0),s.add(a))}),o.requiredDependencies.forEach(r=>{let a=r instanceof L?r:G.get(r.getRequiredTask().getId(),r.getRequiredByTask().getId());!a||s.has(a)||(this.deleteDependency(a,!1,!0),s.add(a))});this.pushUndo({type:"deleteTasks",tasks:t,dependencies:[...s]}),this.deleteFromStorage([...n,...s])}createDependency(e,t){if(e.getRequired().has(t.getId()))return e.getRequired().get(t.getId());let n=e instanceof x?e:D.get(e.getId());if(!n)throw new Error("Required task does not exist");let s=t instanceof x?t:D.get(t.getId());if(!s)throw new Error("Required by task does not exist");let o=new L(n,s);G.set(n.id,s.id,o),n.requiredByDependencies.set(s.id,o),s.requiredDependencies.set(n.id,o);let r=this.presenter.addDependency(o);return o.arrow=r,this.pushUndo({type:"addDependency",from:n.getId(),to:s.getId()}),this.saveToStorage(o),o}deleteDependency(e,t=!0,n=!1){let s=e instanceof L?e:G.get(e.getRequiredTask().getId(),e.getRequiredByTask().getId());if(s){let o=s.getRequiredTask(),r=s.getRequiredByTask();if(t){let a=o instanceof x?o:D.get(o.getId());if(!a)throw new Error("Required task does not exist");let d=r instanceof x?r:D.get(r.getId());if(!d)throw new Error("Required by task does not exist");a.requiredByDependencies.delete(d.getId()),d.requiredDependencies.delete(a.getId())}G.delete(o.getId(),r.getId()),this.presenter.removeDependency(s),n||this.pushUndo({type:"deleteDependency",from:o.getId(),to:r.getId()}),this.deleteFromStorage(s)}}pauseCanvas(){this.presenter.pauseCanvas(),this.canvasIsPaused=!0}unpauseCanvas(){this.presenter.unpauseCanvas(),this.canvasIsPaused=!1}pushUndo(e){}undo(){throw new Error("Method not implemented.")}redo(){throw new Error("Method not implemented.")}async requestConnectionToStorage(e=!0){if(this.storageConnectionProviders.length===1){let t=this.storageConnectionProviders[0];e&&this.pauseCanvas();let s=await this.presenter.showModal("New or Existing Canvas","Would you like to create a new canvas or load an existing one?",[["NEW","New Canvas"],["LOAD","Open Canvas"]])==="NEW";return await t.requestAuthentication()&&(this.storageProvider=await t.requestConnection(s)),e&&this.unpauseCanvas(),this.storageProvider}throw this.storageConnectionProviders.length===0?new Error("No storage connection providers available"):new Error("Multiple storage connection providers - not yet implemented")}async load(e=!0){if(!this.storageProvider)throw new Error("No storage provider connected");e&&this.pauseCanvas();let t=await this.storageProvider.retrieveCanvasData();t.tasks.forEach(n=>{let s=new x({id:n.id,title:n.title,description:n.description,position:y.new(n.position.x,n.position.y),completed:n.completed,collapsed:n.collapsed});D.set(s.id,s),this.presenter.addTaskToCanvas(s)}),t.dependencies.forEach(n=>{let s=D.get(n.requiredTaskId),o=D.get(n.requiredByTaskId);if(!s||!o)return;let r=new L(s,o);G.set(s.id,o.id,r),s.requiredByDependencies.set(o.id,r),o.requiredDependencies.set(s.id,r);let a=this.presenter.addDependency(r);r.arrow=a}),e&&this.unpauseCanvas()}saveToStorage(e){this.storageProvider?Array.isArray(e)?this.storageProvider.saveMany(e.map(t=>t.toStorageModel())):e instanceof x?this.storageProvider.saveTask(e.toStorageModel()):e instanceof L&&this.storageProvider.saveDependency(e.toStorageModel()):console.warn("No storage provider connected")}deleteFromStorage(e){this.storageProvider?Array.isArray(e)?this.storageProvider.deleteMany(e.map(t=>t.toStorageModel())):e instanceof x?this.storageProvider.deleteTask(e.toStorageModel()):e instanceof L&&this.storageProvider.deleteDependency(e.toStorageModel()):console.warn("No storage provider connected")}};var ge=function(){let i=null,e=null,t=null,n=null,s=!1,o=!1,r=5,a=200,d=!1;function h(m){m.button===0?(e=m,s=!1):m.button===2&&(t=m,o=!1)}function f(m){if(p(u("mousemove",m)),e&&!s){let c=m.clientX-e.clientX,g=m.clientY-e.clientY;Math.sqrt(c*c+g*g)>r&&(s=!0,p(u("mousedown",e)))}if(t&&!o){let c=m.clientX-t.clientX,g=m.clientY-t.clientY;Math.sqrt(c*c+g*g)>r&&(o=!0,p(u("mousedown",t)))}}function l(m){let c=Date.now();m.button===0?(s?p(u("mouseup",m)):n&&c-n.time<a?(p(u("dblclick",m)),n=null):(n={event:m,time:c},setTimeout(()=>{n&&Date.now()-n.time>=a&&(p(u("click",m)),n=null)},a)),e=null,s=!1):m.button===2?(p(u(o?"mouseup":"contextmenu",m)),t=null,o=!1):p(u("mouseup",m))}function u(m,c){return{type:m,button:c.button,clientX:c.clientX,clientY:c.clientY,pageX:c.pageX!==void 0?c.pageX:c.clientX+window.scrollX,pageY:c.pageY!==void 0?c.pageY:c.clientY+window.scrollY,target:c.target,originalEvent:c}}function p(m){if(typeof i=="function")try{i(m)}catch(c){console.error("InputInterpreter callback error:",c)}}function T(m){if(typeof m!="function")throw new Error("MouseInputInterpreter.init requires a callback function");i=m,d||(document.addEventListener("mousedown",h),document.addEventListener("mousemove",f),document.addEventListener("mouseup",l),d=!0)}function w(){d&&(document.removeEventListener("mousedown",h),document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",l),d=!1),i=null,e=null,t=null,n=null,s=!1,o=!1}return{init:T,destroy:w}}();var oe=class{constructor(){this.mousePosition=B.zero;this.mouseMovement=new O(k.zero);this.leftPressed=!1;this.rightPressed=!1;this.middlePressed=!1;this.leftDownScreenPosition=B.zero;this.rightDownScreenPosition=B.zero;this.middleDownScreenPosition=B.zero;this.leftDownCanvasPosition=null;this.rightDownCanvasPosition=null;this.middleDownCanvasPosition=null;this.keys={};this.lastEvent=null;this.target=null;this.taskInTitleEditMode=null;this.taskInDescriptionEditMode=null;this.taskHeldByMouse=null;this.taskHeldByMouseOriginalCanvasPosition=y.zero;this.taskHeldByMouseCurrentCanvasPosition=y.zero;this.selectedTasks=new Set;this.selectionBoxStart=B.zero;this.contextMenuContext=null;this.dependencyCreationContext=null;this.taskTitleEditContext=null;this.taskDescriptionEditContext=null;this.canvasPanningContext=null;this.mouseIsHoldingDependencyArrow=!1;this.mouseIsHoldingSingleTask=!1;this.mouseIsHoldingTaskGroup=!1;this.mouseIsHoldingCanvas=!1;this.mouseIsDrawingSelectionBox=!1}};var A=40,re=6,ie=class{constructor(e,t){this.controlState=new oe;this.app=e,this.presenter=t,this.init()}init(){document.addEventListener("contextmenu",e=>{e.preventDefault()},!0),ge.init(e=>{this.updateControlState(e)}),["keydown","keyup"].forEach(e=>{document.addEventListener(e,t=>this.updateControlState(t))})}updateControlState(e){this.controlState.lastEvent=e,e.clientX!==void 0&&e.clientY!==void 0&&(this.controlState.mousePosition=B.new(e.clientX,e.clientY)),this.controlState.mouseMovement=O.new(e.movementX||0,e.movementY||0),this.controlState.target=e.target,e.type==="mousedown"?e.button===0?(this.controlState.leftPressed=!0,this.controlState.leftDownScreenPosition=this.controlState.mousePosition,this.controlState.leftDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===2?(this.controlState.rightPressed=!0,this.controlState.rightDownScreenPosition=this.controlState.mousePosition,this.controlState.rightDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===1&&(this.controlState.middlePressed=!0,this.controlState.middleDownScreenPosition=this.controlState.mousePosition,this.controlState.middleDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.type==="mouseup"?e.button===0?this.controlState.leftPressed=!1:e.button===2?this.controlState.rightPressed=!1:e.button===1&&(this.controlState.middlePressed=!1):e.type==="keydown"?e.key&&(this.controlState.keys[e.key]=!0):e.type==="keyup"&&e.key&&(this.controlState.keys[e.key]=!1),this.interpretIntent()}interpretIntent(){let e=this.controlState.lastEvent;if(e&&!this.app.isCanvasPaused()){if(this.controlState.contextMenuContext){if(e.type==="click"||e.type==="dblclick"||e.type==="mouseup"){this.handleContextMenuSelection();return}else if(e.type==="contextmenu"&&this.handleContextMenuSelection())return}if(this.controlState.dependencyCreationContext){let t=this.controlState.dependencyCreationContext;if(e.type==="mousemove"){let n=this.presenter.getTask(this.controlState.target)??this.controlState.mousePosition.toCanvasCoords();t.firstTaskIsRequiredTask?this.presenter.updateArrow(t.ghostArrow,{target:n,isGhostArrow:!0}):this.presenter.updateArrow(t.ghostArrow,{source:n,isGhostArrow:!0})}else if(e.type==="click"&&e.button===0){let n=this.presenter.getTask(this.controlState.target);n&&(t.firstTaskIsRequiredTask?this.app.createDependency(t.firstTask,n):this.app.createDependency(n,t.firstTask)),this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}else if(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape"){this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}return}if(this.controlState.mouseIsHoldingCanvas){if(e.type==="mousemove"){let t=this.controlState.mouseMovement;this.presenter.panCanvas(t)}else e.type==="mouseup"&&e.button===2&&(this.controlState.mouseIsHoldingCanvas=!1);return}if(this.controlState.mouseIsHoldingSingleTask){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.leftDownCanvasPosition),o=this.controlState.taskHeldByMouseOriginalCanvasPosition.add(n);if(A>0&&!this.controlState.keys.Alt){let r=Math.round(o.x/A)*A,a=Math.round(o.y/A)*A,d=Math.abs(o.x-r),h=Math.abs(o.y-a);o=y.new(d<re?r:o.x,h<re?a:o.y)}this.controlState.taskHeldByMouseCurrentCanvasPosition=o,this.presenter.moveTask(this.controlState.taskHeldByMouse,o,!1)}else e.type==="mouseup"&&e.button===0?(this.controlState.taskHeldByMouse&&this.app.moveTasks([{task:this.controlState.taskHeldByMouse,position:this.controlState.taskHeldByMouseCurrentCanvasPosition}]),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null):(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskHeldByMouse&&this.presenter.moveTask(this.controlState.taskHeldByMouse,this.controlState.taskHeldByMouseOriginalCanvasPosition),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null);return}if(this.controlState.mouseIsHoldingTaskGroup){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.taskGroupAnchorOriginalMouseCanvasPosition),s=this.controlState.taskGroupOriginalPositions.get(this.controlState.taskGroupAnchor),o=s.add(n);if(A>0&&!this.controlState.keys.Alt){let r=Math.round(o.x/A)*A,a=Math.round(o.y/A)*A,d=Math.abs(o.x-r),h=Math.abs(o.y-a);o=y.new(d<re?r:o.x,h<re?a:o.y)}n=o.subtractCoords(s),this.presenter.moveTask(this.controlState.taskGroupAnchor,o,!1),this.controlState.selectedTasks.forEach(r=>{if(r===this.controlState.taskGroupAnchor)return;let d=this.controlState.taskGroupOriginalPositions.get(r).add(n);this.presenter.moveTask(r,d,!1)})}else if(e.type==="mouseup"&&e.button===0){let t=[];this.controlState.selectedTasks.forEach(n=>{let s=this.presenter.getTaskPositionOnCanvas(n);t.push({task:n,position:s})}),this.app.moveTasks(t),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition}else(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskGroupOriginalPositions.forEach((t,n)=>{this.presenter.moveTask(n,t)}),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition);return}if(this.controlState.mouseIsDrawingSelectionBox){if(e.type==="mousemove"){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition;this.presenter.moveSelectionBox(t,n)}else if(e.type==="mouseup"&&e.button===0){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition,s=this.presenter.getTasksInArea(t,n),o=this.controlState.keys.Alt||this.controlState.keys.Meta;for(let r of s)o?this.deselectTask(r):this.selectTask(r);this.releaseSelectionBox()}else e.type==="contextmenu"&&e.button===2?this.releaseSelectionBox():e.type==="keydown"&&e.key==="Escape"&&this.releaseSelectionBox();return}if(this.controlState.taskTitleEditContext){let t=this.controlState.taskTitleEditContext,n=()=>{let s=this.presenter.getTaskTitle(t.task);this.presenter.toggleEditModeForTaskTitle(t.task,!1),s&&s.length>0?this.app.changeTaskTitle(t.task,s):this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null};if(e.type==="keydown"&&e.key==="Enter"){n();return}if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let s=this.presenter.getTaskInfo(this.controlState.target);if(s?.task===t.task&&s.component==="title")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskTitle(t.task,!1),this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null;return}else if(e.type==="keydown"||e.type==="keyup")return}if(this.controlState.taskDescriptionEditContext){let t=this.controlState.taskDescriptionEditContext,n=()=>{let s=this.presenter.getTaskDescription(t.task);this.presenter.toggleEditModeForTaskDescription(t.task,!1),s&&s.length>0?this.app.changeTaskDescription(t.task,s):this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null};if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let s=this.presenter.getTaskInfo(this.controlState.target);if(s?.task===t.task&&s.component==="description")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskDescription(t.task,!1),this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null;return}else if(e.type==="keydown"||e.type==="keyup")return}if(e.type==="mousedown"){if(e.button===0){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n){let s=this.controlState.selectedTasks.has(n);if(!s&&this.controlState.keys.Shift&&(this.selectTask(n),s=!0),s){this.tryGrabTaskGroup(n);return}else{this.tryGrabSingleTask(n);return}}else if(this.tryGrabSelectionBox()){this.controlState.keys.Shift||this.deselectAllTasks();return}}else if(e.button===2){this.tryGrabCanvas();return}return}if((e.type==="click"||e.type==="dblclick")&&e.button===0){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n&&this.controlState.keys.Shift){this.controlState.selectedTasks.has(n)?this.deselectTask(n):this.selectTask(n);return}if(this.deselectAllTasks(),n){if(e.type==="dblclick"&&t.component==="header"){this.app.toggleTaskExpansion(n,null);return}if(t.component==="title"){let s=t.task.getTitle();this.presenter.toggleEditModeForTaskTitle(n,!0),this.controlState.taskTitleEditContext={task:n,originalTitle:s};return}if(t.component==="description"){let s=t.task.getDescription();this.presenter.toggleEditModeForTaskDescription(n,!0),this.controlState.taskDescriptionEditContext={task:n,originalDescription:s};return}if(t.component==="collapse"){this.app.toggleTaskExpansion(n,null);return}if(t.component==="completion"){this.app.toggleTaskCompletion(n,null);return}if(e.type==="click"){this.selectTask(n);return}}else if(e.type==="dblclick"){let s=this.controlState.mousePosition.toCanvasCoords(),o=y.new(Math.floor(s.x/A)*A,Math.floor(s.y/A)*A);this.app.createTask(o);return}return}if(e.type==="contextmenu"){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n){let o=[["REQUIRES_DEPENDENCY","Requires Dependency"],["REQUIRED_BY_DEPENDENCY","Required By Dependency"]];this.controlState.selectedTasks.has(n)?o.unshift(["DELETE_SELECTED_TASKS","Delete Selected Tasks"]):o.unshift(["DELETE_TASK","Delete Task"]),this.presenter.showContextMenu(this.controlState.mousePosition,o),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,task:n};return}let s=this.presenter.getDependency(this.controlState.target);if(s){this.presenter.showContextMenu(this.controlState.mousePosition,[["DELETE_DEPENDENCY","Delete Dependency"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,dependency:s};return}else{this.presenter.showContextMenu(this.controlState.mousePosition,[["ADD_TASK","Add Task"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition};return}}if(e.type==="keydown"){if(this.controlState.keys.a&&(this.controlState.keys.Control||this.controlState.keys.Meta)){this.selectAllTasks();return}if(this.controlState.keys.Delete||this.controlState.keys.Backspace){let t=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(t);return}return}}}handleContextMenuSelection(){if(this.controlState.contextMenuContext===null)return!1;let e=this.controlState.contextMenuContext,t=this.presenter.getContextMenuOption(this.controlState.target);if(t==="ADD_TASK"){let n=e.position.toCanvasCoords();this.app.createTask(n)}else if(t==="DELETE_TASK")e.task&&(this.controlState.selectedTasks.delete(e.task),this.app.deleteTasks([e.task]));else if(t==="DELETE_SELECTED_TASKS"){let n=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(n)}else if(t==="REQUIRES_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!1)}else if(t==="REQUIRED_BY_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!0)}else if(t==="DELETE_DEPENDENCY"){if(!e.dependency)throw new Error("Dependency is null");this.app.deleteDependency(e.dependency)}return this.controlState.contextMenuContext=null,this.presenter.hideContextMenu(),t!=null}mouseIsHoldingSomething(){return this.controlState.mouseIsHoldingSingleTask||this.controlState.mouseIsHoldingTaskGroup||this.controlState.mouseIsHoldingCanvas||this.controlState.mouseIsHoldingDependencyArrow||this.controlState.mouseIsDrawingSelectionBox}releaseAllMouseHolds(){this.controlState.mouseIsHoldingDependencyArrow&&(this.controlState.mouseIsHoldingDependencyArrow=!1),this.controlState.mouseIsHoldingSingleTask&&(this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null),this.controlState.mouseIsHoldingTaskGroup&&(this.controlState.mouseIsHoldingTaskGroup=!1),this.controlState.mouseIsHoldingCanvas&&(this.controlState.mouseIsHoldingCanvas=!1),this.controlState.mouseIsDrawingSelectionBox&&this.releaseSelectionBox()}tryGrabSingleTask(e){return this.controlState.mouseIsHoldingSingleTask&&this.controlState.taskHeldByMouse===e?!0:this.mouseIsHoldingSomething()?!1:(this.controlState.mouseIsHoldingSingleTask=!0,this.controlState.taskHeldByMouse=e,this.controlState.taskHeldByMouseOriginalCanvasPosition=this.presenter.getTaskPositionOnCanvas(e),this.presenter.adjustTaskZPosition(e,y.zero),!0)}tryGrabTaskGroup(e){return this.controlState.mouseIsHoldingTaskGroup?!0:this.mouseIsHoldingSomething()||this.controlState.selectedTasks.size===0?!1:(this.controlState.mouseIsHoldingTaskGroup=!0,this.controlState.taskGroupAnchor=e,this.presenter.adjustTaskZPosition(e,y.zero),this.controlState.taskGroupOriginalPositions=new Map,this.controlState.selectedTasks.forEach(t=>{this.controlState.taskGroupOriginalPositions.set(t,this.presenter.getTaskPositionOnCanvas(t))}),this.controlState.taskGroupAnchorOriginalMouseCanvasPosition=this.controlState.mousePosition.toCanvasCoords(),!0)}tryGrabCanvas(){return this.controlState.mouseIsHoldingCanvas?!0:this.mouseIsHoldingSomething()?!1:(this.controlState.mouseIsHoldingCanvas=!0,!0)}tryGrabDependencyArrow(e,t){if(this.controlState.mouseIsHoldingDependencyArrow)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsHoldingDependencyArrow=!0;let n=this.controlState.mousePosition.toCanvasCoords(),s=t?e:n,o=t?n:e,r=this.presenter.createArrow(s,o);return this.controlState.dependencyCreationContext={firstTask:e,firstTaskIsRequiredTask:t,ghostArrow:r},!0}tryGrabSelectionBox(){if(this.controlState.mouseIsDrawingSelectionBox)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsDrawingSelectionBox=!0,this.controlState.selectionBoxStart=this.controlState.mousePosition;let e=this.controlState.selectionBoxStart,t=this.controlState.mousePosition;return this.presenter.moveSelectionBox(e,t),this.presenter.showSelectionBox(),!0}releaseSelectionBox(){this.presenter.hideSelectionBox(),this.controlState.mouseIsDrawingSelectionBox=!1}selectTask(e){this.controlState.selectedTasks.add(e),this.presenter.toggleTaskHighlight(e,!0)}selectAllTasks(){let e=this.presenter.getAllTasks();this.controlState.selectedTasks=new Set(e),this.presenter.toggleAllTaskHighlights(!0)}deselectTask(e){this.controlState.selectedTasks.delete(e),this.presenter.toggleTaskHighlight(e,!1)}deselectAllTasks(){this.controlState.selectedTasks.clear(),this.presenter.toggleAllTaskHighlights(!1)}};var ke=function(){let i=0,e=20,t=10,n=10,s=2;function o(l,u){return l instanceof P?u==="start"?l.position.translate(l.size.x,20):l.position.translate(0,20):l}function r(l,u,p){let T=(l+u)/2;return Math.round(T/p)*p}function a(l,u,p,T,w){let c;if(l.x<=u.x&&u.x-l.x>=2*10){let g=l.x+10,C=u.x-10,v=Math.ceil(g/p)*p,I=Math.floor(C/p)*p;if(v<I){let S=r(v,I,p);c=[l,new k(v,l.y),new k(S,l.y),new k(S,u.y),new k(I,u.y),u]}else v===I&&(c=[l,new k(v,l.y),new k(v,u.y),u])}if(!c){let g=Math.ceil((l.x+10)/p)*p,C=Math.floor((u.x-10)/p)*p,v=T instanceof P?T.bottom:l.y,I=w instanceof P?w.top:u.y,S=Math.round((v+I)/2/p)*p;c=[l,new k(g,l.y),new k(g,S),new k(C,S),new k(C,u.y),u]}if(c.length>0){let g=c[c.length-1];g.x===u.x&&(c[c.length-1]=g.translate(-s,0))}return c}function d(l,u){let p=l.map(C=>C.x),T=l.map(C=>C.y),w=Math.min(...p),m=Math.min(...T),c=Math.max(...p),g=Math.max(...T);return new P(new k(w-u,m-u),new k(c-w+2*u,g-m+2*u))}function h(l){if(!l.length)return l;let u=[l[0]];for(let p=1;p<l.length;p++){let T=u[u.length-1];(l[p].x!==T.x||l[p].y!==T.y)&&u.push(l[p])}return u}function f(l,u){if(l=h(l),l.length===0)return"";if(l.length===1)return`M ${l[0].x},${l[0].y}`;if(l.length===2)return`M ${l[0].x},${l[0].y} L ${l[1].x},${l[1].y}`;let p=`M ${l[0].x},${l[0].y}`,T=l[0],w=[l[0]];for(let c=1;c<l.length-1;c++){let g=l[c],C=l[c+1],v=g.sub(T),I=C.sub(g);if(v.x===0&&I.x===0||v.y===0&&I.y===0){w.push(g),T=g;continue}let S=v.normalize(),b=I.normalize(),Z=S.negate().dot(b),q=Math.min(1,Math.max(-1,Z)),R=Math.acos(q);if(R===0){w.push(g),T=g;continue}let $=u/Math.tan(R/2),pe=Math.sqrt(v.lenSqr()),M=Math.sqrt(I.lenSqr()),Q=Math.min($,pe,M),H=Q*Math.tan(R/2),z=g.sub(S.mul(Q)),V=g.add(b.mul(Q));w.push(z),w.push({arc:!0,center:g,from:z,to:V,r:H,u1:S,u2:b,theta:R}),w.push(V),T=V}w.push(l[l.length-1]);let m=w[0];p=`M ${m.x},${m.y}`;for(let c=1;c<w.length;c++){let g=w[c];if(g.arc)continue;let C=g;if(c<w.length-1&&w[c+1].arc){p+=` L ${C.x},${C.y}`;let v=w[c+1],S=v.u1.x*v.u2.y-v.u1.y*v.u2.x<0?0:1;p+=` A ${v.r},${v.r} 0 0,${S} ${v.to.x},${v.to.y}`,c+=2}else p+=` L ${C.x},${C.y}`}return p}return{createArrow:function(l,u,p,T={}){T=T||{};let w=T.gridSize||e,m=t;i++;let c="http://www.w3.org/2000/svg",g=o(u,"start"),C=o(p,"end"),v=!1;u instanceof P&&u.contains(C)&&(v=!0),p instanceof P&&p.contains(g)&&(v=!0);let I=a(g,C,w,u,p);I||(v=!0);let S=d(I||[g,C],m),b=document.createElementNS(c,"svg");b.style.position="absolute",b.style.left=S.left+"px",b.style.top=S.top+"px",b.style.width=S.width+"px",b.style.height=S.height+"px",b.style.overflow="visible",b.style.pointerEvents="none",b.dataset.role="dependency-arrow",l.appendChild(b),T.dataId&&(b.dataset.id=T.dataId);let ue="arrowhead-"+i,Z=document.createElementNS(c,"defs"),q=document.createElementNS(c,"marker");q.setAttribute("id",ue),q.setAttribute("markerWidth","6"),q.setAttribute("markerHeight","6"),q.setAttribute("refX","5"),q.setAttribute("refY","3"),q.setAttribute("orient","auto"),q.setAttribute("viewBox","0 0 6 6");let R=document.createElementNS(c,"path");R.setAttribute("d","M0,0 L6,3 L0,6 L1.5,3 z"),R.setAttribute("fill",T.color||"white"),R.style.pointerEvents="visiblePainted",q.appendChild(R),Z.appendChild(q),b.appendChild(Z);let $;I?$=I.map(H=>H.sub(S.position)):$=[g.sub(S.position),C.sub(S.position)];let pe=f($,n),M=document.createElementNS(c,"path");return M.setAttribute("d",pe),M.setAttribute("fill","none"),M.setAttribute("stroke",T.color||"white"),M.setAttribute("stroke-width",s.toString()),M.setAttribute("marker-end",`url(#${ue})`),M.style.pointerEvents="visiblePainted",v&&(M.style.display="none"),b.appendChild(M),{svg:b,update:function(H,z){let V=o(H,"start"),J=o(z,"end"),ee=!1;H instanceof P&&H.contains(J)&&(ee=!0),z instanceof P&&z.contains(V)&&(ee=!0);let te=a(V,J,w,H,z);te||(ee=!0);let K=d(te||[V,J],m);b.style.left=K.left+"px",b.style.top=K.top+"px",b.style.width=K.width+"px",b.style.height=K.height+"px";let fe=te?te.map(ye=>ye.sub(K.position)):[V.sub(K.position),J.sub(K.position)],ve=f(fe,n);M.setAttribute("d",ve),M.style.display=ee?"none":"block"},remove:function(){b.parentNode&&b.parentNode.removeChild(b)},addEventListener:function(H,z,V){M.addEventListener(H,z,V)},setColor:function(H){M.setAttribute("stroke",H),R.setAttribute("fill",H)}}}}}();var U=class{constructor(e,t){this.element=e;this.onClose=t?.onClose;let n=this.element.querySelector(".modal-title");n.textContent=t?.title||"",t?.title?n.style.removeProperty("display"):n.style.display="none";let s=this.element.querySelector(".modal-body");s.innerHTML=t?.message||"",t?.message?s.style.removeProperty("display"):s.style.display="none";let o=this.element.querySelector(".modal-footer");o.innerHTML="";let r=t?.options||[];for(let[d,h]of r){let f=document.createElement("div");f.className="modal-button",f.textContent=h,f.onclick=()=>{try{t?.onSelection&&t.onSelection(d)}finally{this.close()}},o.appendChild(f)}r.length===0?o.style.display="none":o.style.removeProperty("display");let a=this.element.querySelector(".modal-close");a.onclick=()=>this.close(),t?.allowClose?a.style.removeProperty("display"):a.style.display="none"}static makeHtmlElement(){let e=document.createElement("div");e.className="modal-dialog",e.style.display="none";let t=document.createElement("div");t.className="modal-content",e.appendChild(t);let n=document.createElement("div");n.className="modal-header",t.appendChild(n);let s=document.createElement("div");s.className="modal-title",n.appendChild(s);let o=document.createElement("div");o.className="modal-close",o.innerHTML="&times;",n.appendChild(o);let r=document.createElement("div");r.className="modal-body",t.appendChild(r);let a=document.createElement("div");return a.className="modal-footer",t.appendChild(a),e}show(){this.element.style.removeProperty("display")}hide(){this.element.style.display="none"}close(){this.hide(),this.onClose&&this.onClose()}};var ae=class{constructor(){this.orderedTasks=[];this.canvas=null;this.selectionBoxElement=null;this.contextMenuElement=null;this.taskMap=new Map;this.dependencyMap=new Map;this.canvas=document.getElementById("canvas"),E.init(this.canvas),this.contextMenuElement=document.getElementById("contextMenu"),this.contextMenuElement||(this.contextMenuElement=document.createElement("div"),this.contextMenuElement.id="contextMenu",this.contextMenuElement.style.position="absolute",this.contextMenuElement.style.display="none",document.body.appendChild(this.contextMenuElement));let e=document.createElement("div");e.id="modalScreen",e.style.position="fixed",e.style.inset="0",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.display="none",e.style.zIndex="1000",document.body.appendChild(e),this.modalDialogElement=U.makeHtmlElement(),this.modalDialogElement.style.zIndex="1001",document.body.appendChild(this.modalDialogElement),this.modalScreen=e}pauseCanvas(){this.modalScreen.style.display="block"}unpauseCanvas(){this.modalScreen.style.display="none"}showModal(e,t,n){return new Promise(s=>{new U(this.modalDialogElement,{title:e,message:t,options:n,allowClose:!1,onSelection:r=>{s(r)}}).show()})}panCanvas(e){E.panBy(e.vec)}getTaskPositionOnCanvas(e){let t=this.getTaskElement(e);if(!t)throw new Error("Task element not found");return y.new(t.offsetLeft,t.offsetTop)}toggleTaskHighlight(e,t){let n=this.getTaskElement(e);n&&(t?n.classList.add("selected"):n.classList.remove("selected"))}toggleAllTaskHighlights(e){(this.canvas?.querySelectorAll(".task")).forEach(n=>{e?n.classList.add("selected"):n.classList.remove("selected")})}showSelectionBox(){if(!this.canvas)throw new Error("Canvas not initialized");this.selectionBoxElement||(this.selectionBoxElement=document.createElement("div"),this.selectionBoxElement.style.position="absolute",this.selectionBoxElement.style.border="1px dashed lightblue",this.selectionBoxElement.style.backgroundColor="rgba(173,216,230,0.2)",this.selectionBoxElement.style.pointerEvents="none",this.canvas.appendChild(this.selectionBoxElement))}moveSelectionBox(e,t){if(!this.selectionBoxElement)return;let n=Math.min(e.x,t.x),s=Math.min(e.y,t.y),o=E.getScale(),r=E.getTranslation();n=(n-r.x)/o,s=(s-r.y)/o;let a=Math.abs(e.x-t.x)/o,d=Math.abs(e.y-t.y)/o;this.selectionBoxElement.style.left=n+"px",this.selectionBoxElement.style.top=s+"px",this.selectionBoxElement.style.width=a+"px",this.selectionBoxElement.style.height=d+"px"}hideSelectionBox(){this.selectionBoxElement&&(this.selectionBoxElement.remove(),this.selectionBoxElement=null)}getAllTasks(){return Array.from(this.taskMap.values()).map(e=>e.task)}getTasksInArea(e,t){if(!this.canvas)throw new Error("Canvas not initialized");let n=N.fromPoints(e,t),s=[];return this.canvas.querySelectorAll(".task").forEach(r=>{let a=N.fromElementBounds(r);if(n.intersects(a)){let d=r.getAttribute("data-id"),h=d?parseInt(d):null;h&&this.taskMap.has(h)&&s.push(this.taskMap.get(h).task)}}),s}showContextMenu(e,t){let n=this.contextMenuElement;if(!n)throw new Error("Not initialized");n.innerHTML="",t.forEach(s=>{let o=document.createElement("div");o.textContent=s[1],o.setAttribute("data-role","context-menu-item"),o.setAttribute("data-key",s[0]),n.appendChild(o)}),n.style.left=e.x+"px",n.style.top=e.y+"px",n.style.display="block"}hideContextMenu(){this.contextMenuElement&&(this.contextMenuElement.style.display="none")}addTaskToCanvas(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=document.createElement("div");t.classList.add("task"),t.setAttribute("data-id",e.getId().toString());let n=e.getPosition();n&&(t.style.left=n.x+"px",t.style.top=n.y+"px",t.setAttribute("data-snapped",n.x%40===0&&n.y%40===0?"true":"false"));let s=document.createElement("div");s.classList.add("task-header");let o=document.createElement("div");o.classList.add("toggle"),o.setAttribute("data-role","toggle"),o.textContent=e.isExpanded()?"\u25BC":"\u25BA",s.appendChild(o);let r=document.createElement("div");r.classList.add("title"),r.setAttribute("data-role","title"),r.textContent=e.getTitle(),s.appendChild(r);let a=document.createElement("div");a.classList.add("custom-checkbox"),a.setAttribute("data-role","checkbox");let d=document.createElement("div");d.classList.add("checkbox-fill"),d.innerHTML=`
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" style="background: transparent;">
  <rect x="1" y="1" width="26" height="26" rx="3.75" ry="3.75" fill="none" stroke="#4d4d4d" stroke-width="2"></rect>
  <defs>
    <mask id="checkMask-${e.getId()}">
      <rect x="0" y="0" width="28" height="28" fill="white"></rect>
      <polyline points="8,15 12,19 20,9" stroke="black" stroke-width="2" stroke-linecap="round" fill="none" stroke-linejoin="round"></polyline>
    </mask>
  </defs>
  <rect x="4" y="4" width="20" height="20" rx="1.9" ry="1.9" fill="#25a599" fill-opacity="${e.isComplete()?"1":"0.1"}" mask="url(#checkMask-${e.getId()})"></rect>
</svg>`,a.appendChild(d),s.appendChild(a),t.appendChild(s);let h=document.createElement("div");h.classList.add("task-body"),t.appendChild(h);let f=document.createElement("div");f.classList.add("description"),f.setAttribute("data-role","description"),f.innerHTML=e.getDescription(),h.appendChild(f),n&&this.adjustTaskZPositionInternal(t,n),this.taskMap.set(e.getId(),{task:e,element:t})}moveTask(e,t,n=!0){let s=this.taskMap.get(e.getId());if(!s)return;let o=s.element;o.style.left=t.x+"px",o.style.top=t.y+"px",n&&this.adjustTaskZPositionInternal(o,t)}adjustTaskZPosition(e,t){let n=this.taskMap.get(e.getId());n&&this.adjustTaskZPositionInternal(n.element,t)}adjustTaskZPositionInternal(e,t){let n=this.orderedTasks.find(o=>o.element===e);n?(n.position=t,this.orderedTasks=this.orderedTasks.filter(o=>o.element!==e)):n={id:parseInt(e.getAttribute("data-id")||"-1"),element:e,position:t};let s=this.orderedTasks.findIndex(o=>t.y>o.position.y||t.y===o.position.y&&t.x>o.position.x);if(s===-1&&(s=this.orderedTasks.length),this.orderedTasks.splice(s,0,n),!this.canvas)throw new Error("Canvas not initialized");s===this.orderedTasks.length-1?this.canvas.appendChild(e):this.canvas.insertBefore(e,this.orderedTasks[s+1].element)}toggleEditModeForTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="title"]'),r=o instanceof HTMLInputElement?o:null;if(t)r||(r=document.createElement("input"),r.dataset.role="title",r.type="text",r.value=o.textContent||"",r.style.width="100%",o.replaceWith(r),r.focus());else if(r){let a=document.createElement("div");a.dataset.role="title",a.classList.add("title"),a.textContent=r.value,r.replaceWith(a)}}getTaskTitle(e){let t=this.taskMap.get(e.getId());if(!t)return"";let s=t.element.querySelector('[data-role="title"]'),o=s instanceof HTMLInputElement?s:null;return o?o.value:s.textContent||""}setTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="title"]'),r=o instanceof HTMLInputElement?o:null;r?r.value=t:o.textContent=t}toggleEditModeForTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="description"]');if(t){if(o&&o.classList.contains("editor-container"))return;let r=o?o.innerHTML:"",a=document.createElement("div");a.classList.add("editor-container"),a.setAttribute("data-role","description"),a.style.minHeight="50px";let d=document.createElement("div");a.appendChild(d),o&&o.parentNode&&o.parentNode.replaceChild(a,o);let h=new Quill(d,{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{color:[]},{background:[]}],[{align:[]}],["clean"]]}});h.root.innerHTML=r,h.focus(),setTimeout(()=>h.setSelection(h.getLength(),0),0);let f=()=>{let l=h.root.scrollHeight;d.style.height=l+"px"};h.on("text-change",f),f(),a._quill=h}else{if(!o||!o.classList.contains("editor-container"))return;let r=o._quill;if(!r)return;let a=r.root.innerHTML,d=document.createElement("div");d.classList.add("description"),d.setAttribute("data-role","description"),d.innerHTML=a,o.parentNode?.replaceChild(d,o)}}getTaskDescription(e){let t=this.taskMap.get(e.getId());if(!t)return null;let s=t.element.querySelector('[data-role="description"]');if(!s)return null;if(s.classList.contains("editor-container")){let o=s._quill;return o?o.root.innerHTML:null}else return s.innerHTML}setTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="description"]');if(o)if(o.classList.contains("editor-container")){let r=o._quill;r&&(r.root.innerHTML=t)}else o.innerHTML=t}toggleTaskCompletion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let s=n.querySelector(".checkbox-fill");if(s){let o=s.querySelector("rect[mask]");o&&o.setAttribute("fill-opacity",t?"1":"0.1")}}toggleTaskExpansion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let s=n.querySelector(".task-body");s&&(s.style.display=t?"none":"block");let o=n.querySelector(".toggle");o&&(o.textContent=t?"\u25BA":"\u25BC")}removeTask(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=this.taskMap.get(e.getId());t&&(t.element.remove(),this.taskMap.delete(e.getId()));let n=this.orderedTasks.findIndex(s=>s.id===e.getId());n!==-1&&this.orderedTasks.splice(n,1)}addDependency(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=e.getRequiredTask(),n=e.getRequiredByTask(),s=this.dependencyKey(t.getId(),n.getId()),o=new F(this,t,n,e,s,this.canvas);return this.dependencyMap.set(s,o),o}removeDependency(e){let t=this.dependencyKey(e.getRequiredTask().getId(),e.getRequiredByTask().getId()),n=this.dependencyMap.get(t);n&&(n.remove(),this.dependencyMap.delete(t))}createArrow(e,t){if(!this.canvas)throw new Error("Canvas not initialized");return new F(this,e,t,null,null,this.canvas)}updateArrow(e,t){if(!(e instanceof F))throw new Error("Invalid arrow");let n=e;if(n.update(t?.source||null,t?.target||null),t?.isGhostArrow){let s=t.source?t.source:n.getSource(),o=t.target?t.target:n.getTarget(),h=s instanceof y||o instanceof y?"#b3555588":"#55b38888";n.setColor(h)}else n.setColor(F.defaultColor)}removeArrow(e){e.remove()}getTaskInfo(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id"),s=n?parseInt(n):null;if(!s||!this.taskMap.has(s))return null;let o=this.taskMap.get(s).task;return e.closest('[data-role="title"]')?{task:o,component:"title"}:e.closest('[data-role="description"]')?{task:o,component:"description"}:e.closest('[data-role="toggle"]')?{task:o,component:"collapse"}:e.closest('[data-role="checkbox"]')?{task:o,component:"completion"}:e.closest(".task-header")?{task:o,component:"header"}:{task:o,component:"task"}}getTask(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id"),s=n?parseInt(n):null;return s?this.taskMap.get(s).task:null}getDependency(e){let t=e.closest('[data-role="dependency-arrow"]');if(!t)return null;let n=t.getAttribute("data-id");return n&&this.dependencyMap.get(n)?.dependency||null}getContextMenuOption(e){if(!e)return null;let t=e.closest('[data-role="context-menu-item"]');return t?t.getAttribute("data-key"):null}getTaskElement(e){let t=this.taskMap.get(e.getId());return t?t.element:null}getTaskElementFromChild(e){return e.closest(".task")}dependencyKey(e,t){return e+"->"+t}},F=class i{constructor(e,t,n,s,o,r){this.presenter=e;this.dependency=s;this.source=this.setSource(t),this.target=this.setTarget(n),this.arrow=ke.createArrow(r,this.getArrowSource(),this.getArrowTarget(),{color:i.defaultColor,dataId:o||void 0}),r.prepend(this.arrow.svg)}static{this.defaultColor="#b3b3b3"}getSource(){return this.source instanceof y?this.source:this.source.task}setSource(e){if(e instanceof y)this.source=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid source");this.source=new le(e,t)}return this.source}getArrowSource(){if(this.source instanceof y)return this.source.vec;if(this.source.element)return N.fromElementBounds(this.source.element).toCanvasRect().rect;throw new Error("Invalid source")}getTarget(){return this.target instanceof y?this.target:this.target.task}setTarget(e){if(e instanceof y)this.target=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid target");this.target=new le(e,t)}return this.target}getArrowTarget(){if(this.target instanceof y)return this.target.vec;if(this.target.element)return N.fromElementBounds(this.target.element).toCanvasRect().rect;throw new Error("Invalid target")}update(e,t){e&&this.setSource(e),t&&this.setTarget(t);let n=this.getArrowSource(),s=this.getArrowTarget();this.arrow.update(n,s)}setColor(e){this.arrow.setColor(e)}remove(){this.arrow.remove()}},le=class{constructor(e,t){this.task=e;this.element=t}};var ce=class{constructor(){this.CLIENT_ID="834406545740-fpa6k2omak75t15u8ve4t7n0t3r1r0ig.apps.googleusercontent.com";this.API_KEY="AIzaSyCMJf3NuTEBASgWaXTQhy6fiM9QY0GAitg";this.DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];this.SCOPES="https://www.googleapis.com/auth/drive";this.tokenClient=null;this.accessToken=null;this.init()}init(){gapi.load("client",()=>{gapi.client.init({apiKey:this.API_KEY,discoveryDocs:this.DISCOVERY_DOCS}).then(()=>{console.log("GAPI client initialized.")}).catch(e=>{console.error("Error initializing GAPI client:",e)})}),this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:this.CLIENT_ID,scope:this.SCOPES,callback:e=>{e.error?console.error("Error during token acquisition:",e.error):(this.accessToken=X.fromResponse(e),console.log("Access token acquired:",this.accessToken.token))}})}tryAutoSignIn(){let e=X.getExisting();return e?(this.accessToken=e,!0):!1}signIn(){return new Promise((e,t)=>{if(!this.tokenClient)return t(new Error("Token client not initialized."));let n=this.tokenClient.callback;this.tokenClient.callback=s=>{s.error?(console.error("Sign-in error:",s.error),e(!1)):(this.accessToken=X.fromResponse(s),console.log("User signed in, token:",this.accessToken.token),e(!0)),this.tokenClient.callback=n},this.tokenClient.requestAccessToken()})}async getAccessTokenValidFor(e){let t=this.accessToken||X.getExisting();if(t&&!t.expiresWithin(e))return t;for(;;)if(await this.signIn(),this.accessToken?.expiresWithin(e)===!1)return this.accessToken}pickFolder(){return new Promise(e=>{gapi.load("picker",async()=>{let t=new google.picker.DocsView(google.picker.ViewId.FOLDERS).setParent("root").setMode(google.picker.DocsViewMode.LIST).setSelectFolderEnabled(!0),n=await this.getAccessTokenValidFor(60);new google.picker.PickerBuilder().addView(t).setOAuthToken(n.token).setDeveloperKey(this.API_KEY).setCallback(o=>{if(o.action===google.picker.Action.PICKED){let r=o.docs[0].id;e(r)}else o.action===google.picker.Action.CANCEL&&e(null)}).build().setVisible(!0)})})}pickFile(e){let t=Array.isArray(e)?e.length>0?e.join(","):void 0:e;return new Promise(n=>{gapi.load("picker",async()=>{let s=new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(!0).setParent("root").setMode(google.picker.DocsViewMode.LIST);t&&s.setMimeTypes(t);let o=await this.getAccessTokenValidFor(60);new google.picker.PickerBuilder().addView(s).setOAuthToken(o.token).setDeveloperKey(this.API_KEY).setCallback(a=>{if(a.action===google.picker.Action.PICKED){let d=a.docs[0].id;n(d)}else a.action===google.picker.Action.CANCEL&&n(null)}).build().setVisible(!0)})})}saveAs(e,t,n,s){return new Promise(async o=>{let r=new Blob([n],{type:s}),a={name:e,mimeType:s};t!=="root"&&(a.parents=[t]);let d=new FormData;d.append("metadata",new Blob([JSON.stringify(a)],{type:"application/json"})),d.append("file",r);let h=await this.getAccessTokenValidFor(20);fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{method:"POST",headers:new Headers({Authorization:"Bearer "+h.token}),body:d}).then(f=>f.json()).then(f=>{o(f.id)}).catch(f=>{console.error("Error creating file:",f),o(null)})})}save(e,t,n){return new Promise(async s=>{let o=await this.getAccessTokenValidFor(20);fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:new Headers({Authorization:"Bearer "+o.token,"Content-Type":n||"text/plain"}),body:t}).then(()=>s()).catch(r=>{console.error("Error saving file:",r),s()})})}open(e){return new Promise(async t=>{let n=await this.getAccessTokenValidFor(20);fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:new Headers({Authorization:"Bearer "+n.token})}).then(s=>s.text()).then(s=>t(s)).catch(s=>{console.error("Error opening file:",s),t(null)})})}},X=class i{constructor(e,t,n){this.token=e;this.expires=t;n&&(localStorage.setItem(i.TOKEN_KEY,e),localStorage.setItem(i.EXPIRY_KEY,t.toISOString()))}static{this.TOKEN_KEY="googleAccessToken"}static{this.EXPIRY_KEY="googleAccessTokenExpires"}static getExisting(){let e=localStorage.getItem(i.TOKEN_KEY);if(!e)return null;let t=localStorage.getItem(i.EXPIRY_KEY);if(!t)return null;try{let n=new Date(t);return n.getTime()-Date.now()<=6e4?null:new i(e,n,!1)}catch{return null}}static fromResponse(e){if(!e.access_token||!e.expires_in)throw new Error(`Invalid access token response: ${JSON.stringify(e)}`);let t=e.access_token,n=new Date(Date.now()+e.expires_in*1e3);return new i(t,n,!0)}expiresWithin(e){return this.expires.getTime()-Date.now()<=e*1e3}};var j=class{constructor(e,t,n){this._service=e,this.fileId=t,this.mimeType=n,this.canvasData=new W}async retrieveCanvasData(){let e=await this._service.open(this.fileId),t=e?JSON.parse(e):void 0;return this.canvasData=new W(t),t??this.canvasData.toStorageModel()}saveCanvasData(e){return this.canvasData=new W(e),this.save()}saveTask(e){return this.canvasData.addOrUpdateTask(new Y(e)),this.save()}async deleteTask(e){return this.canvasData.removeTask(new Y(e))?(await this.save(),!0):!1}async saveDependency(e){this.canvasData.addDependency(e)&&await this.save()}async deleteDependency(e){return this.canvasData.removeDependency(e)?(await this.save(),!0):!1}async saveMany(e){let t=!1;for(let n of e){let[s,o]=this.resolveDataModel(n);s?t=this.canvasData.addOrUpdateTask(new Y(s))||t:o&&(t=this.canvasData.addDependency(o)||t)}t&&await this.save()}async deleteMany(e){let t=!1;for(let n of e){let s=n;s.title||(s=void 0);let o=n;(s||!o.requiredTaskId)&&(o=void 0),s?t=this.canvasData.removeTask(new Y(s))||t:o&&(t=this.canvasData.removeDependency(o)||t)}t&&await this.save()}resolveDataModel(e){let t=e;t.title||(t=void 0);let n=e;return(t||!n.requiredTaskId)&&(n=void 0),[t,n]}async save(){let e=JSON.stringify(this.canvasData.toStorageModel(),null,2);return this._service.save(this.fileId,e,this.mimeType)}},W=class{constructor(e){this.version=e?.version||"1.0",this.taskMap=e?.tasks?new Map(e.tasks.map(t=>[t.id,new Y(t)])):new Map,this.depMap=e?.dependencies?new Map(e.dependencies.map(t=>[`${t.requiredTaskId}->${t.requiredByTaskId}`,t])):new Map,this.pan=e?.pan||{x:0,y:0},this.zoom=e?.zoom||1}addOrUpdateTask(e){return this.taskMap.set(e.id,e),!0}removeTask(e){return this.taskMap.delete(e.id)}addDependency(e){let t=`${e.requiredTaskId}->${e.requiredByTaskId}`;return this.depMap.has(t)?!1:(this.depMap.set(t,e),!0)}removeDependency(e){return this.depMap.delete(`${e.requiredTaskId}->${e.requiredByTaskId}`)}toStorageModel(){return{version:this.version,tasks:[...this.taskMap.values()],dependencies:[...this.depMap.values()],pan:this.pan,zoom:this.zoom}}},Y=class{constructor(e){this.id=e.id,this.title=e.title,this.description=e.description,this.completed=e.completed,this.position={x:e.position.x,y:e.position.y},this.collapsed=e.collapsed}};var me="application/vnd.taskcanvas+json",de=class i{constructor(){this.signedIn=!1;i._service??=new ce,this._service=i._service}async requestAuthentication(){return!this.signedIn&&(this.signedIn=this._service.tryAutoSignIn(),this.signedIn)?!0:(this.signedIn=await this._service.signIn(),this.signedIn)}async requestConnection(e){if(!this.signedIn)return console.error("Not signed in to Google Drive."),null;if(e){let t=confirm(`Do you want to choose a folder for your new task canvas file?

Click OK for folder selection, or Cancel to use the root folder.`),n="root";if(t&&(n=await this._service.pickFolder(),!n))return null;let s=prompt("Enter the file name for the new canvas file (e.g., mycanvas.tc):");if(!s)return null;s.endsWith(".tc")||(s+=".tc");let o={version:"1.0",tasks:[],dependencies:[],pan:{x:0,y:0},zoom:1},r=await this.createNewFile(s,n,o);return r?new j(this._service,r,me):null}else{let n=await this._service.pickFile(me);return n?new j(this._service,n,me):null}}createNewFile(e,t,n){return this._service.saveAs(e,t,JSON.stringify(n,null,2))}};document.addEventListener("DOMContentLoaded",()=>{let i=new ae,e=new de,t=new se(i,[e]),n=new ie(t,i);t.pauseCanvas(),s().then(()=>t.load());async function s(){let o=null;for(;!o;)o=await t.requestConnectionToStorage(!1)}});})();
//# sourceMappingURL=app.js.map
