"use strict";(()=>{var ne=class{constructor(e){this.map=new Map;if(e)for(let[t,n,s]of e)this.set(t,n,s)}set(e,t,n){let s=this.map.get(e);s||(s=new Map,this.map.set(e,s)),s.set(t,n)}get(e,t){let n=this.map.get(e);return n?n.get(t):void 0}delete(e,t){let n=this.map.get(e),s=!1;return n&&(s=n.delete(t),n.size===0&&this.map.delete(e)),s}has(e,t){let n=this.map.get(e);return n?n.has(t):!1}clear(){this.map.clear()}getKeys1(){return this.map.keys()}getKeys2(e){let t=this.map.get(e);return t?t.keys():[].values()}getValues(){let e=[];for(let t of this.map.values())for(let n of t.values())e.push(n);return e.values()}getEntries(){let e=[];for(let[t,n]of this.map)for(let[s,o]of n)e.push([t,s,o]);return e.values()}};var k=class a{constructor(e,t){this.x=e;this.y=t}static{this.zero=new a(0,0)}static{this.identity=new a(1,1)}static{this.up=new a(0,-1)}static{this.down=new a(0,1)}static{this.left=new a(-1,0)}static{this.right=new a(1,0)}lenSqr(){return this.x*this.x+this.y*this.y}add(e){return new a(this.x+e.x,this.y+e.y)}sub(e){return new a(this.x-e.x,this.y-e.y)}mul(e){return new a(this.x*e,this.y*e)}div(e){return new a(this.x/e,this.y/e)}translate(e,t){return new a(this.x+e,this.y+t)}negate(){return new a(-this.x,-this.y)}normalize(){let e=this.lenSqr();if(e===0)return a.zero;let t=1/Math.sqrt(e);return new a(this.x*t,this.y*t)}dot(e){return this.x*e.x+this.y*e.y}},A=class a{constructor(e,t){this.position=e;this.size=t}static fromBounds(e){return new a(new k(e.left,e.top),new k(e.right-e.left,e.bottom-e.top))}static fromPoints(e,t){return new a(new k(Math.min(e.x,t.x),Math.min(e.y,t.y)),new k(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}get left(){return this.position.x}get right(){return this.position.x+this.size.x}get top(){return this.position.y}get bottom(){return this.position.y+this.size.y}get width(){return this.size.x}get height(){return this.size.y}scale(e,t){return new a(this.position.sub(t).mul(e).add(t),this.size.mul(e))}contains(e){return e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom}intersects(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}};var x=class{static{this.minScale=.25}static{this.maxScale=2}static{this.scrollIncrement=20}static{this.canvas=null}static{this.scale=1}static{this.translation=k.zero}static init(e){this.canvas=e,this.canvas.style.transformOrigin="0 0",this.canvas.style.cursor="default",this.updateTransform(),(this.canvas.parentElement||this.canvas).addEventListener("wheel",t=>this.onWheel(t),{passive:!1})}static updateTransform(){this.canvas&&(this.canvas.style.transform=`translate(${this.translation.x}px, ${this.translation.y}px) scale(${this.scale})`)}static onWheel(e){if(e.preventDefault(),e.ctrlKey){let t=e.deltaY*-.001,n=new k(e.clientX,e.clientY);this.setScale(this.scale*(1+t),n)}else{let t=0,n=0,s=this.scrollIncrement*this.scale;e.shiftKey?e.deltaY>0?t=-s:e.deltaY<0&&(t=s):(e.deltaY>0?n=-s:e.deltaY<0&&(n=s),e.deltaX>0?t=-s:e.deltaX<0&&(t=s));let o=this.translation.add(new k(t,n)),i=t?Math.round(o.x/s)*s:o.x,r=n?Math.round(o.y/s)*s:o.y,u=new k(i,r);this.setTranslation(u)}}static setScale(e,t){if(e=Math.max(this.minScale,Math.min(this.maxScale,e)),e!==this.scale&&this.canvas){let n=e/this.scale;this.translation=this.translation.mul(n).add(t.mul(1-n)),this.scale=e,this.updateTransform()}}static panBy(e){this.translation=this.translation.add(e),this.updateTransform()}static getScale(){return this.scale}static getTranslation(){return this.translation}static setTranslation(e){this.translation=e,this.updateTransform()}};var D=class a{constructor(e){this.vec=e}static new(e,t){return new a(new k(e,t))}static fromEvent(e){return a.new(e.clientX,e.clientY)}static{this.zero=new a(k.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new a(this.vec.add(e.vec))}sub(e){return new a(this.vec.sub(e.vec))}subtractCoords(e){return new O(this.vec.sub(e.vec))}toCanvasCoords(){let e=x.getScale(),t=x.getTranslation();return w.new((this.x-t.x)/e,(this.y-t.y)/e)}},O=class a{constructor(e){this.vec=e}static new(e,t){return new a(new k(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new a(this.vec.add(e.vec))}sub(e){return new a(this.vec.sub(e.vec))}toCanvasSize(){let e=x.getScale?x.getScale():1;return new U(this.vec.div(e))}},N=class a{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new A(e.vec,t.vec)}static fromElementBounds(e){let t=e.getBoundingClientRect();return new a(D.new(t.left,t.top),O.new(t.width,t.height))}static fromPoints(e,t){return new a(D.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),O.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toCanvasRect(){return new ge(this.position.toCanvasCoords(),this.size.toCanvasSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}},w=class a{constructor(e){this.vec=e}static new(e,t){return new a(new k(e,t))}static{this.zero=new a(k.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new a(this.vec.add(e.vec))}sub(e){return new a(this.vec.sub(e.vec))}subtractCoords(e){return new U(this.vec.sub(e.vec))}toScreenCoords(){let e=x.getScale?x.getScale():1,t=x.getTranslation();return D.new(this.x*e+t.x,this.y*e+t.y)}},U=class a{constructor(e){this.vec=e}static new(e,t){return new a(new k(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new a(this.vec.add(e.vec))}sub(e){return new a(this.vec.sub(e.vec))}toScreenSize(){let e=x.getScale?x.getScale():1;return new O(this.vec.mul(e))}},ge=class a{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new A(e.vec,t.vec)}static fromPoints(e,t){return new a(w.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),U.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toScreenRect(){return new N(this.position.toScreenCoords(),this.size.toScreenSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}};var E=class a{constructor(e={}){this.requiredDependencies=new Map;this.requiredByDependencies=new Map;e.id&&(a.taskIdCounter=Math.max(a.taskIdCounter,e.id+1)),this.id=e.id||a.taskIdCounter++,this.title=e.title??"New Task",this.description=e.description??"",this.position=e.position??null,this.completed=e.completed??!1,this.collapsed=e.collapsed??!0}static{this.taskIdCounter=1}getId(){return this.id}getTitle(){return this.title}getDescription(){return this.description}isComplete(){return this.completed}getRequired(){return this.requiredDependencies}getRequiredBy(){return this.requiredByDependencies}getPosition(){return this.position}isExpanded(){return!this.collapsed}toStorageModel(){if(!this.position)throw new Error("Task must have a position to be saved");return{id:this.id,title:this.title,description:this.description,completed:this.completed,position:this.position,collapsed:this.collapsed}}};var q=class{constructor(e,t){this.requiredTask=e;this.requiredByTask=t}getRequiredTask(){return this.requiredTask}getRequiredByTask(){return this.requiredByTask}toStorageModel(){return{requiredTaskId:this.requiredTask.getId(),requiredByTaskId:this.requiredByTask.getId()}}};var M=new Map,K=new ne;var se=class{constructor(e,t,n){this.presenter=e;this.storageConnectionProviders=t;this.queryStringHandler=n;this.storageProvider=null;this.canvasIsPaused=!1}isCanvasPaused(){return this.canvasIsPaused}createTask(e){let t=new E({position:e});return M.set(t.id,t),this.presenter.addTaskToCanvas(t),this.pushUndo({type:"addTask",task:t}),this.saveToStorage(t),t}toggleTaskCompletion(e,t){let n=e instanceof E?e:M.get(e.getId());if(!n)throw new Error("Task does not exist");n.completed=t===null?!n.completed:t,this.presenter.toggleTaskCompletion(n,n.completed),this.pushUndo({type:"toggleComplete",taskId:n.id,newValue:n.completed,oldValue:!n.completed}),this.saveToStorage(n)}toggleTaskExpansion(e,t,n=!1){let s=e instanceof E?e:M.get(e.getId());if(!s)throw new Error("Task does not exist");s.collapsed=t===null?!s.collapsed:!t,this.presenter.toggleTaskExpansion(s,s.collapsed),n||this.pushUndo({type:"toggleCollapse",taskId:s.id,newValue:s.collapsed,oldValue:!s.collapsed}),this.saveToStorage(s)}changeTaskTitle(e,t){let n=e instanceof E?e:M.get(e.getId());if(!n)throw new Error("Task does not exist");let s=n.title;n.title=t,this.presenter.setTaskTitle(n,t),this.pushUndo({type:"editTask",taskId:n.id,field:"title",newTitle:t,oldTitle:s}),this.saveToStorage(n)}changeTaskDescription(e,t){let n=e instanceof E?e:M.get(e.getId());if(!n)throw new Error("Task does not exist");let s=n.description;n.description=t,this.presenter.setTaskDescription(n,t),t||this.toggleTaskExpansion(n,!1),this.pushUndo({type:"editTask",taskId:n.id,field:"description",newDescription:t,oldDescription:s}),this.saveToStorage(n)}moveTasks(e){let t=[],n=[];e.forEach(s=>{let{task:o,position:i}=s,r=o instanceof E?o:M.get(o.getId());if(!r)throw new Error("Task does not exist");let u=r.getPosition()||w.zero;r.position=i,this.presenter.moveTask(r,i),r.requiredByDependencies.forEach(p=>{let f=p instanceof q?p:K.get(p.getRequiredTask().getId(),p.getRequiredByTask().getId());f?.arrow&&this.presenter.updateArrow(f.arrow)}),r.requiredDependencies.forEach(p=>{let f=p instanceof q?p:K.get(p.getRequiredTask().getId(),p.getRequiredByTask().getId());f?.arrow&&this.presenter.updateArrow(f.arrow)}),t.push({taskId:r.getId(),oldPosition:u,newPosition:i}),n.push(r)}),this.pushUndo({type:"moveTasks",taskMovements:t}),this.saveToStorage(n)}deleteTasks(e){let t=e.map(o=>{let i=o instanceof E?o:M.get(o.getId());if(!i)throw new Error("Task does not exist");return i}),n=new Set,s=new Set;for(let o of t)this.presenter.removeTask(o),M.delete(o.getId()),n.add(o),o.requiredByDependencies.forEach(i=>{let r=i instanceof q?i:K.get(i.getRequiredTask().getId(),i.getRequiredByTask().getId());!r||s.has(r)||(this.deleteDependency(r,!1,!0),s.add(r))}),o.requiredDependencies.forEach(i=>{let r=i instanceof q?i:K.get(i.getRequiredTask().getId(),i.getRequiredByTask().getId());!r||s.has(r)||(this.deleteDependency(r,!1,!0),s.add(r))});this.pushUndo({type:"deleteTasks",tasks:t,dependencies:[...s]}),this.deleteFromStorage([...n,...s])}createDependency(e,t){if(e.getRequired().has(t.getId()))return e.getRequired().get(t.getId());let n=e instanceof E?e:M.get(e.getId());if(!n)throw new Error("Required task does not exist");let s=t instanceof E?t:M.get(t.getId());if(!s)throw new Error("Required by task does not exist");let o=new q(n,s);K.set(n.id,s.id,o),n.requiredByDependencies.set(s.id,o),s.requiredDependencies.set(n.id,o);let i=this.presenter.addDependency(o);return o.arrow=i,this.pushUndo({type:"addDependency",from:n.getId(),to:s.getId()}),this.saveToStorage(o),o}deleteDependency(e,t=!0,n=!1){let s=e instanceof q?e:K.get(e.getRequiredTask().getId(),e.getRequiredByTask().getId());if(s){let o=s.getRequiredTask(),i=s.getRequiredByTask();if(t){let r=o instanceof E?o:M.get(o.getId());if(!r)throw new Error("Required task does not exist");let u=i instanceof E?i:M.get(i.getId());if(!u)throw new Error("Required by task does not exist");r.requiredByDependencies.delete(u.getId()),u.requiredDependencies.delete(r.getId())}K.delete(o.getId(),i.getId()),this.presenter.removeDependency(s),n||this.pushUndo({type:"deleteDependency",from:o.getId(),to:i.getId()}),this.deleteFromStorage(s)}}pauseCanvas(){this.presenter.pauseCanvas(),this.canvasIsPaused=!0}unpauseCanvas(){this.presenter.unpauseCanvas(),this.canvasIsPaused=!1}pushUndo(e){}undo(){throw new Error("Method not implemented.")}redo(){throw new Error("Method not implemented.")}async requestConnectionToStorage(e=!0){if(this.storageConnectionProviders.length===1){let t=this.storageConnectionProviders[0];e&&this.pauseCanvas();let s=await this.presenter.showModal("New or Existing Canvas","Would you like to create a new canvas or load an existing one?",[["NEW","New Canvas"],["LOAD","Open Canvas"]])==="NEW";return await t.requestAuthentication()&&(this.storageProvider=await t.requestConnection(s)),e&&this.unpauseCanvas(),this.storageProvider&&this.storageProvider.locationId&&this.queryStringHandler.setStorageLocation({source:t.uniqueName,id:this.storageProvider.locationId}),this.storageProvider}throw this.storageConnectionProviders.length===0?new Error("No storage connection providers available"):new Error("Multiple storage connection providers - not yet implemented")}async requestConnectionToStorageLocation(e,t=!0){let n=this.storageConnectionProviders.find(o=>o.uniqueName===e.source);return n?(t&&this.pauseCanvas(),await n.requestAuthentication()&&(this.storageProvider=await n.requestConnectionToLocation(e.id)),t&&this.unpauseCanvas(),this.storageProvider&&this.storageProvider.locationId&&this.queryStringHandler.setStorageLocation({source:n.uniqueName,id:this.storageProvider.locationId}),this.storageProvider):(console.warn("Storage connection provider not found"),null)}async load(e=!0){if(!this.storageProvider)throw new Error("No storage provider connected");e&&this.pauseCanvas();let t=await this.storageProvider.retrieveCanvasData();t.tasks.forEach(n=>{let s=new E({id:n.id,title:n.title,description:n.description,position:w.new(n.position.x,n.position.y),completed:n.completed,collapsed:n.collapsed});M.set(s.id,s),this.presenter.addTaskToCanvas(s)}),t.dependencies.forEach(n=>{let s=M.get(n.requiredTaskId),o=M.get(n.requiredByTaskId);if(!s||!o)return;let i=new q(s,o);K.set(s.id,o.id,i),s.requiredByDependencies.set(o.id,i),o.requiredDependencies.set(s.id,i);let r=this.presenter.addDependency(i);i.arrow=r}),e&&this.unpauseCanvas()}saveToStorage(e){this.storageProvider?Array.isArray(e)?this.storageProvider.saveMany(e.map(t=>t.toStorageModel())):e instanceof E?this.storageProvider.saveTask(e.toStorageModel()):e instanceof q&&this.storageProvider.saveDependency(e.toStorageModel()):console.warn("No storage provider connected")}deleteFromStorage(e){this.storageProvider?Array.isArray(e)?this.storageProvider.deleteMany(e.map(t=>t.toStorageModel())):e instanceof E?this.storageProvider.deleteTask(e.toStorageModel()):e instanceof q&&this.storageProvider.deleteDependency(e.toStorageModel()):console.warn("No storage provider connected")}};var oe=class a{constructor(){this.params=new Map;let e=new URL(window.location.href);this.initialPath=e.pathname,this.initialQueryString=e.search,this.params=a.parseQueryString(this.initialQueryString)}getStorageLocation(){let e=this.params.get("s");if(!e)return null;let t=this.params.get("l");return t?{source:e,id:t}:null}setStorageLocation(e){this.params.set("s",e.source),this.params.set("l",e.id);let t=a.stringifyQueryString(this.params),n=this.initialPath+t;window.history.replaceState({},"",n)}static parseQueryString(e){let t=new Map;return e.startsWith("?")&&(e=e.substring(1)),e.split("&").forEach(n=>{if(!n)return;let[s,o=""]=n.split("="),i=decodeURIComponent(s),r=decodeURIComponent(o);t.set(i,r)}),t}static stringifyQueryString(e){let t=[];return e.forEach((n,s)=>{let o=encodeURIComponent(s),i=encodeURIComponent(n);t.push(`${o}=${i}`)}),t.length?"?"+t.join("&"):""}};var fe=function(){let a=null,e=null,t=null,n=null,s=null,o=null,i=!1,r=!1,u=!1,p=5,f=200,l=!1;function h(c){c.button===0?(e=c,i=!1):c.button===2?(t=c,r=!1):c.button===1&&(n=c,u=!1)}function m(c){if(S(g("mousemove",c)),e&&!i){let d=c.clientX-e.clientX,b=c.clientY-e.clientY;Math.sqrt(d*d+b*b)>p&&(i=!0,S(g("mousedown",e)))}if(t&&!r){let d=c.clientX-t.clientX,b=c.clientY-t.clientY;Math.sqrt(d*d+b*b)>p&&(r=!0,S(g("mousedown",t)))}if(n&&!u){let d=c.clientX-n.clientX,b=c.clientY-n.clientY;Math.sqrt(d*d+b*b)>p&&(u=!0,S(g("mousedown",n)))}}function T(c){let d=Date.now();c.button===0?(i?S(g("mouseup",c)):s&&d-s.time<f?(S(g("dblclick",c)),s=null):(s={event:c,time:d},setTimeout(()=>{s&&Date.now()-s.time>=f&&(S(g("click",c)),s=null)},f)),e=null,i=!1):c.button===2?(S(g(r?"mouseup":"contextmenu",c)),t=null,r=!1):c.button===1?(u?S(g("mouseup",c)):o&&d-o.time<f?(S(g("dblclick",c)),o=null):(o={event:c,time:d},setTimeout(()=>{o&&Date.now()-o.time>=f&&(S(g("click",c)),o=null)},f)),n=null,u=!1):S(g("mouseup",c))}function g(c,d){return{type:c,button:d.button,clientX:d.clientX,clientY:d.clientY,pageX:d.pageX!==void 0?d.pageX:d.clientX+window.scrollX,pageY:d.pageY!==void 0?d.pageY:d.clientY+window.scrollY,target:d.target,originalEvent:d}}function S(c){if(typeof a=="function")try{a(c)}catch(d){console.error("InputInterpreter callback error:",d)}}function v(c){if(typeof c!="function")throw new Error("MouseInputInterpreter.init requires a callback function");a=c,l||(document.addEventListener("mousedown",h),document.addEventListener("mousemove",m),document.addEventListener("mouseup",T),l=!0)}function y(){l&&(document.removeEventListener("mousedown",h),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",T),l=!1),a=null,e=null,t=null,n=null,s=null,o=null,i=!1,r=!1,u=!1}return{init:v,destroy:y}}();var ie=class{constructor(){this.mousePosition=D.zero;this.mouseMovement=new O(k.zero);this.leftPressed=!1;this.rightPressed=!1;this.middlePressed=!1;this.leftDownScreenPosition=D.zero;this.rightDownScreenPosition=D.zero;this.middleDownScreenPosition=D.zero;this.leftDownCanvasPosition=null;this.rightDownCanvasPosition=null;this.middleDownCanvasPosition=null;this.keys={};this.lastEvent=null;this.target=null;this.taskInTitleEditMode=null;this.taskInDescriptionEditMode=null;this.taskHeldByMouse=null;this.taskHeldByMouseOriginalCanvasPosition=w.zero;this.taskHeldByMouseCurrentCanvasPosition=w.zero;this.selectedTasks=new Set;this.selectionBoxStart=D.zero;this.contextMenuContext=null;this.dependencyCreationContext=null;this.taskTitleEditContext=null;this.taskDescriptionEditContext=null;this.canvasPanningContext=null;this.mouseIsHoldingDependencyArrow=!1;this.mouseIsHoldingSingleTask=!1;this.mouseIsHoldingTaskGroup=!1;this.mouseIsDrawingSelectionBox=!1}};var L=40,re=6,ae=class{constructor(e,t){this.controlState=new ie;this.app=e,this.presenter=t,this.init()}init(){document.addEventListener("contextmenu",e=>{e.preventDefault()},!0),fe.init(e=>{this.updateControlState(e)}),["keydown","keyup"].forEach(e=>{document.addEventListener(e,t=>this.updateControlState(t))})}updateControlState(e){this.controlState.lastEvent=e,e.clientX!==void 0&&e.clientY!==void 0&&(this.controlState.mousePosition=D.new(e.clientX,e.clientY)),this.controlState.mouseMovement=O.new(e.movementX||0,e.movementY||0),this.controlState.target=e.target,e.type==="mousedown"?e.button===0?(this.controlState.leftPressed=!0,this.controlState.leftDownScreenPosition=this.controlState.mousePosition,this.controlState.leftDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===2?(this.controlState.rightPressed=!0,this.controlState.rightDownScreenPosition=this.controlState.mousePosition,this.controlState.rightDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===1&&(this.controlState.middlePressed=!0,this.controlState.middleDownScreenPosition=this.controlState.mousePosition,this.controlState.middleDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.type==="mouseup"?e.button===0?this.controlState.leftPressed=!1:e.button===2?this.controlState.rightPressed=!1:e.button===1&&(this.controlState.middlePressed=!1):e.type==="keydown"?e.key&&(this.controlState.keys[e.key]=!0):e.type==="keyup"&&e.key&&(this.controlState.keys[e.key]=!1),this.interpretIntent()}interpretIntent(){let e=this.controlState.lastEvent;if(e&&!this.app.isCanvasPaused()){if(this.controlState.contextMenuContext){if(e.type==="click"||e.type==="dblclick"||e.type==="mouseup"){this.handleContextMenuSelection();return}else if(e.type==="contextmenu"&&this.handleContextMenuSelection())return}if(this.controlState.dependencyCreationContext){let t=this.controlState.dependencyCreationContext;if(e.type==="mousemove"){let n=this.presenter.getTask(this.controlState.target)??this.controlState.mousePosition.toCanvasCoords();t.firstTaskIsRequiredTask?this.presenter.updateArrow(t.ghostArrow,{target:n,isGhostArrow:!0}):this.presenter.updateArrow(t.ghostArrow,{source:n,isGhostArrow:!0})}else if(e.type==="click"&&e.button===0){let n=this.presenter.getTask(this.controlState.target);n&&(t.firstTaskIsRequiredTask?this.app.createDependency(t.firstTask,n):this.app.createDependency(n,t.firstTask)),this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}else if(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape"){this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}return}if(this.controlState.canvasPanningContext){if(e.type==="mousemove"){let t=this.controlState.canvasPanningContext,n=this.controlState.mousePosition.subtractCoords(t.originalMousePosition),s=t.originalCanvasPan.add(n);this.presenter.setCanvasPan(s);return}else e.type==="mouseup"&&!this.controlState.rightPressed&&!this.controlState.middlePressed&&(this.controlState.canvasPanningContext=null);return}if(this.controlState.mouseIsHoldingSingleTask){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.leftDownCanvasPosition),o=this.controlState.taskHeldByMouseOriginalCanvasPosition.add(n);if(L>0&&!this.controlState.keys.Alt){let i=Math.round(o.x/L)*L,r=Math.round(o.y/L)*L,u=Math.abs(o.x-i),p=Math.abs(o.y-r);o=w.new(u<re?i:o.x,p<re?r:o.y)}this.controlState.taskHeldByMouseCurrentCanvasPosition=o,this.presenter.moveTask(this.controlState.taskHeldByMouse,o,!1)}else e.type==="mouseup"&&e.button===0?(this.controlState.taskHeldByMouse&&this.app.moveTasks([{task:this.controlState.taskHeldByMouse,position:this.controlState.taskHeldByMouseCurrentCanvasPosition}]),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null):(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskHeldByMouse&&this.presenter.moveTask(this.controlState.taskHeldByMouse,this.controlState.taskHeldByMouseOriginalCanvasPosition),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null);return}if(this.controlState.mouseIsHoldingTaskGroup){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.taskGroupAnchorOriginalMouseCanvasPosition),s=this.controlState.taskGroupOriginalPositions.get(this.controlState.taskGroupAnchor),o=s.add(n);if(L>0&&!this.controlState.keys.Alt){let i=Math.round(o.x/L)*L,r=Math.round(o.y/L)*L,u=Math.abs(o.x-i),p=Math.abs(o.y-r);o=w.new(u<re?i:o.x,p<re?r:o.y)}n=o.subtractCoords(s),this.presenter.moveTask(this.controlState.taskGroupAnchor,o,!1),this.controlState.selectedTasks.forEach(i=>{if(i===this.controlState.taskGroupAnchor)return;let u=this.controlState.taskGroupOriginalPositions.get(i).add(n);this.presenter.moveTask(i,u,!1)})}else if(e.type==="mouseup"&&e.button===0){let t=[];this.controlState.selectedTasks.forEach(n=>{let s=this.presenter.getTaskPositionOnCanvas(n);t.push({task:n,position:s})}),this.app.moveTasks(t),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition}else(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskGroupOriginalPositions.forEach((t,n)=>{this.presenter.moveTask(n,t)}),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition);return}if(this.controlState.mouseIsDrawingSelectionBox){if(e.type==="mousemove"){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition;this.presenter.moveSelectionBox(t,n)}else if(e.type==="mouseup"&&e.button===0){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition,s=this.presenter.getTasksInArea(t,n),o=this.controlState.keys.Alt||this.controlState.keys.Meta;for(let i of s)o?this.deselectTask(i):this.selectTask(i);this.releaseSelectionBox()}else e.type==="contextmenu"&&e.button===2?this.releaseSelectionBox():e.type==="keydown"&&e.key==="Escape"&&this.releaseSelectionBox();return}if(this.controlState.taskTitleEditContext){let t=this.controlState.taskTitleEditContext,n=()=>{let s=this.presenter.getTaskTitle(t.task);this.presenter.toggleEditModeForTaskTitle(t.task,!1),s&&s.length>0?this.app.changeTaskTitle(t.task,s):this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null};if(e.type==="keydown"&&e.key==="Enter"){n();return}if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let s=this.presenter.getTaskInfo(this.controlState.target);if(s?.task===t.task&&s.component==="title")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskTitle(t.task,!1),this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null;return}else if(e.type==="keydown"||e.type==="keyup")return}if(this.controlState.taskDescriptionEditContext){let t=this.controlState.taskDescriptionEditContext,n=()=>{let s=this.presenter.getTaskDescription(t.task);this.presenter.toggleEditModeForTaskDescription(t.task,!1),s!=null?this.app.changeTaskDescription(t.task,s):this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null};if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let s=this.presenter.getTaskInfo(this.controlState.target);if(s?.task===t.task&&s.component==="description")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskDescription(t.task,!1),this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null;return}else if(e.type==="keydown"||e.type==="keyup")return}if(e.type==="mousedown"){let t=e.button;if(t===0){let n=this.presenter.getTaskInfo(this.controlState.target),s=n?n.task:null;if(s){let o=this.controlState.selectedTasks.has(s);if(!o&&this.controlState.keys.Shift&&(this.selectTask(s),o=!0),o){this.tryGrabTaskGroup(s);return}else{this.tryGrabSingleTask(s);return}}else if(this.tryGrabSelectionBox()){this.controlState.keys.Shift||this.deselectAllTasks();return}}else if(t===1||t===2){this.tryGrabCanvas();return}return}if((e.type==="click"||e.type==="dblclick")&&e.button===0){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n&&this.controlState.keys.Shift){this.controlState.selectedTasks.has(n)?this.deselectTask(n):this.selectTask(n);return}if(this.deselectAllTasks(),n){if(e.type==="dblclick"&&t.component==="header"&&(n.isExpanded()||n.getDescription())){this.app.toggleTaskExpansion(n,null);return}if(t.component==="title"){let s=t.task.getTitle();this.presenter.toggleEditModeForTaskTitle(n,!0),this.controlState.taskTitleEditContext={task:n,originalTitle:s};return}if(t.component==="description"){let s=t.task.getDescription();this.presenter.toggleEditModeForTaskDescription(n,!0),this.controlState.taskDescriptionEditContext={task:n,originalDescription:s};return}if(t.component==="collapse"){let s=!n.isExpanded();this.app.toggleTaskExpansion(n,null),s&&!n.getDescription()&&(this.presenter.toggleEditModeForTaskDescription(n,!0),this.controlState.taskDescriptionEditContext={task:n,originalDescription:""});return}if(t.component==="completion"){this.app.toggleTaskCompletion(n,null);return}if(e.type==="click"){this.selectTask(n);return}}else if(e.type==="dblclick"){let s=this.controlState.mousePosition.toCanvasCoords(),o=w.new(Math.floor(s.x/L)*L,Math.floor(s.y/L)*L);this.app.createTask(o);return}return}if(e.type==="contextmenu"){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n){let o=[["REQUIRES_DEPENDENCY","Requires ..."],["REQUIRED_BY_DEPENDENCY","Required by ..."]];this.controlState.selectedTasks.has(n)?o.push(["DELETE_SELECTED_TASKS","Delete Selected Tasks"]):o.push(["DELETE_TASK","Delete Task"]),this.presenter.showContextMenu(this.controlState.mousePosition,o),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,task:n};return}let s=this.presenter.getDependency(this.controlState.target);if(s){this.presenter.showContextMenu(this.controlState.mousePosition,[["DELETE_DEPENDENCY","Delete Dependency"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,dependency:s};return}else{this.presenter.showContextMenu(this.controlState.mousePosition,[["ADD_TASK","Add Task"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition};return}}if(e.type==="keydown"){if(this.controlState.keys.a&&(this.controlState.keys.Control||this.controlState.keys.Meta)){this.selectAllTasks();return}if(this.controlState.keys.Delete||this.controlState.keys.Backspace){let t=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(t);return}return}}}handleContextMenuSelection(){if(this.controlState.contextMenuContext===null)return!1;let e=this.controlState.contextMenuContext,t=this.presenter.getContextMenuOption(this.controlState.target);if(t==="ADD_TASK"){let n=e.position.toCanvasCoords();this.app.createTask(n)}else if(t==="DELETE_TASK")e.task&&(this.controlState.selectedTasks.delete(e.task),this.app.deleteTasks([e.task]));else if(t==="DELETE_SELECTED_TASKS"){let n=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(n)}else if(t==="REQUIRES_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!1)}else if(t==="REQUIRED_BY_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!0)}else if(t==="DELETE_DEPENDENCY"){if(!e.dependency)throw new Error("Dependency is null");this.app.deleteDependency(e.dependency)}return this.controlState.contextMenuContext=null,this.presenter.hideContextMenu(),t!=null}mouseIsHoldingSomething(){return this.controlState.mouseIsHoldingSingleTask||this.controlState.mouseIsHoldingTaskGroup||this.controlState.canvasPanningContext!=null||this.controlState.mouseIsHoldingDependencyArrow||this.controlState.mouseIsDrawingSelectionBox}releaseAllMouseHolds(){this.controlState.mouseIsHoldingDependencyArrow&&(this.controlState.mouseIsHoldingDependencyArrow=!1),this.controlState.mouseIsHoldingSingleTask&&(this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null),this.controlState.mouseIsHoldingTaskGroup&&(this.controlState.mouseIsHoldingTaskGroup=!1),this.controlState.canvasPanningContext&&(this.controlState.canvasPanningContext=null),this.controlState.mouseIsDrawingSelectionBox&&this.releaseSelectionBox()}tryGrabSingleTask(e){return this.controlState.mouseIsHoldingSingleTask&&this.controlState.taskHeldByMouse===e?!0:this.mouseIsHoldingSomething()?!1:(this.controlState.mouseIsHoldingSingleTask=!0,this.controlState.taskHeldByMouse=e,this.controlState.taskHeldByMouseOriginalCanvasPosition=this.presenter.getTaskPositionOnCanvas(e),this.presenter.adjustTaskZPosition(e,w.zero),!0)}tryGrabTaskGroup(e){return this.controlState.mouseIsHoldingTaskGroup?!0:this.mouseIsHoldingSomething()||this.controlState.selectedTasks.size===0?!1:(this.controlState.mouseIsHoldingTaskGroup=!0,this.controlState.taskGroupAnchor=e,this.presenter.adjustTaskZPosition(e,w.zero),this.controlState.taskGroupOriginalPositions=new Map,this.controlState.selectedTasks.forEach(t=>{this.controlState.taskGroupOriginalPositions.set(t,this.presenter.getTaskPositionOnCanvas(t))}),this.controlState.taskGroupAnchorOriginalMouseCanvasPosition=this.controlState.mousePosition.toCanvasCoords(),!0)}tryGrabCanvas(){return this.controlState.canvasPanningContext?!0:this.mouseIsHoldingSomething()||this.controlState.contextMenuContext?!1:(this.controlState.canvasPanningContext={originalMousePosition:this.controlState.mousePosition,originalCanvasPan:this.presenter.getCanvasPan()},!0)}tryGrabDependencyArrow(e,t){if(this.controlState.mouseIsHoldingDependencyArrow)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsHoldingDependencyArrow=!0;let n=this.controlState.mousePosition.toCanvasCoords(),s=t?e:n,o=t?n:e,i=this.presenter.createArrow(s,o);return this.controlState.dependencyCreationContext={firstTask:e,firstTaskIsRequiredTask:t,ghostArrow:i},!0}tryGrabSelectionBox(){if(this.controlState.mouseIsDrawingSelectionBox)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsDrawingSelectionBox=!0,this.controlState.selectionBoxStart=this.controlState.mousePosition;let e=this.controlState.selectionBoxStart,t=this.controlState.mousePosition;return this.presenter.moveSelectionBox(e,t),this.presenter.showSelectionBox(),!0}releaseSelectionBox(){this.presenter.hideSelectionBox(),this.controlState.mouseIsDrawingSelectionBox=!1}selectTask(e){this.controlState.selectedTasks.add(e),this.presenter.toggleTaskHighlight(e,!0)}selectAllTasks(){let e=this.presenter.getAllTasks();this.controlState.selectedTasks=new Set(e),this.presenter.toggleAllTaskHighlights(!0)}deselectTask(e){this.controlState.selectedTasks.delete(e),this.presenter.toggleTaskHighlight(e,!1)}deselectAllTasks(){this.controlState.selectedTasks.clear(),this.presenter.toggleAllTaskHighlights(!1)}};var ve=function(){let a=0,e=20,t=10,n=10,s=2;function o(l,h){return l instanceof A?h==="start"?l.position.translate(l.size.x,20):l.position.translate(0,20):l}function i(l,h,m){let T=(l+h)/2;return Math.round(T/m)*m}function r(l,h,m,T,g){let v;if(l.x<=h.x&&h.x-l.x>=2*10){let y=l.x+10,c=h.x-10,d=Math.ceil(y/m)*m,b=Math.floor(c/m)*m;if(d<b){let I=i(d,b,m);v=[l,new k(d,l.y),new k(I,l.y),new k(I,h.y),new k(b,h.y),h]}else d===b&&(v=[l,new k(d,l.y),new k(d,h.y),h])}if(!v){let y=Math.ceil((l.x+10)/m)*m,c=Math.floor((h.x-10)/m)*m,d=T instanceof A?T.bottom:l.y,b=g instanceof A?g.top:h.y,I=Math.round((d+b)/2/m)*m;v=[l,new k(y,l.y),new k(y,I),new k(c,I),new k(c,h.y),h]}if(v.length>0){let y=v[v.length-1];y.x===h.x&&(v[v.length-1]=y.translate(-s,0))}return v}function u(l,h){let m=l.map(c=>c.x),T=l.map(c=>c.y),g=Math.min(...m),S=Math.min(...T),v=Math.max(...m),y=Math.max(...T);return new A(new k(g-h,S-h),new k(v-g+2*h,y-S+2*h))}function p(l){if(!l.length)return l;let h=[l[0]];for(let m=1;m<l.length;m++){let T=h[h.length-1];(l[m].x!==T.x||l[m].y!==T.y)&&h.push(l[m])}return h}function f(l,h){if(l=p(l),l.length===0)return"";if(l.length===1)return`M ${l[0].x},${l[0].y}`;if(l.length===2)return`M ${l[0].x},${l[0].y} L ${l[1].x},${l[1].y}`;let m=`M ${l[0].x},${l[0].y}`,T=l[0],g=[l[0]];for(let v=1;v<l.length-1;v++){let y=l[v],c=l[v+1],d=y.sub(T),b=c.sub(y);if(d.x===0&&b.x===0||d.y===0&&b.y===0){g.push(y),T=y;continue}let I=d.normalize(),C=b.normalize(),Q=I.negate().dot(C),B=Math.min(1,Math.max(-1,Q)),R=Math.acos(B);if(R===0){g.push(y),T=y;continue}let _=h/Math.tan(R/2),me=Math.sqrt(d.lenSqr()),P=Math.sqrt(b.lenSqr()),Z=Math.min(_,me,P),H=Z*Math.tan(R/2),z=y.sub(I.mul(Z)),V=y.add(C.mul(Z));g.push(z),g.push({arc:!0,center:y,from:z,to:V,r:H,u1:I,u2:C,theta:R}),g.push(V),T=V}g.push(l[l.length-1]);let S=g[0];m=`M ${S.x},${S.y}`;for(let v=1;v<g.length;v++){let y=g[v];if(y.arc)continue;let c=y;if(v<g.length-1&&g[v+1].arc){m+=` L ${c.x},${c.y}`;let d=g[v+1],I=d.u1.x*d.u2.y-d.u1.y*d.u2.x<0?0:1;m+=` A ${d.r},${d.r} 0 0,${I} ${d.to.x},${d.to.y}`,v+=2}else m+=` L ${c.x},${c.y}`}return m}return{createArrow:function(l,h,m,T={}){T=T||{};let g=T.gridSize||e,S=t;a++;let v="http://www.w3.org/2000/svg",y=o(h,"start"),c=o(m,"end"),d=!1;h instanceof A&&h.contains(c)&&(d=!0),m instanceof A&&m.contains(y)&&(d=!0);let b=r(y,c,g,h,m);b||(d=!0);let I=u(b||[y,c],S),C=document.createElementNS(v,"svg");C.style.position="absolute",C.style.left=I.left+"px",C.style.top=I.top+"px",C.style.width=I.width+"px",C.style.height=I.height+"px",C.style.overflow="visible",C.style.pointerEvents="none",C.dataset.role="dependency-arrow",l.appendChild(C),T.dataId&&(C.dataset.id=T.dataId);let he="arrowhead-"+a,Q=document.createElementNS(v,"defs"),B=document.createElementNS(v,"marker");B.setAttribute("id",he),B.setAttribute("markerWidth","6"),B.setAttribute("markerHeight","6"),B.setAttribute("refX","5"),B.setAttribute("refY","3"),B.setAttribute("orient","auto"),B.setAttribute("viewBox","0 0 6 6");let R=document.createElementNS(v,"path");R.setAttribute("d","M0,0 L6,3 L0,6 L1.5,3 z"),R.setAttribute("fill",T.color||"white"),R.style.pointerEvents="visiblePainted",B.appendChild(R),Q.appendChild(B),C.appendChild(Q);let _;b?_=b.map(H=>H.sub(I.position)):_=[y.sub(I.position),c.sub(I.position)];let me=f(_,n),P=document.createElementNS(v,"path");return P.setAttribute("d",me),P.setAttribute("fill","none"),P.setAttribute("stroke",T.color||"white"),P.setAttribute("stroke-width",s.toString()),P.setAttribute("marker-end",`url(#${he})`),P.style.pointerEvents="visiblePainted",d&&(P.style.display="none"),C.appendChild(P),{svg:C,update:function(H,z){let V=o(H,"start"),J=o(z,"end"),ee=!1;H instanceof A&&H.contains(J)&&(ee=!0),z instanceof A&&z.contains(V)&&(ee=!0);let te=r(V,J,g,H,z);te||(ee=!0);let G=u(te||[V,J],S);C.style.left=G.left+"px",C.style.top=G.top+"px",C.style.width=G.width+"px",C.style.height=G.height+"px";let ke=te?te.map(Te=>Te.sub(G.position)):[V.sub(G.position),J.sub(G.position)],ye=f(ke,n);P.setAttribute("d",ye),P.style.display=ee?"none":"block"},remove:function(){C.parentNode&&C.parentNode.removeChild(C)},addEventListener:function(H,z,V){P.addEventListener(H,z,V)},setColor:function(H){P.setAttribute("stroke",H),R.setAttribute("fill",H)}}}}}();var W=class{constructor(e,t){this.element=e;this.onClose=t?.onClose;let n=this.element.querySelector(".modal-title");n.textContent=t?.title||"",t?.title?n.style.removeProperty("display"):n.style.display="none";let s=this.element.querySelector(".modal-body");s.innerHTML=t?.message||"",t?.message?s.style.removeProperty("display"):s.style.display="none";let o=this.element.querySelector(".modal-footer");o.innerHTML="";let i=t?.options||[];for(let[u,p]of i){let f=document.createElement("div");f.className="modal-button",f.textContent=p,f.onclick=()=>{try{t?.onSelection&&t.onSelection(u)}finally{this.close()}},o.appendChild(f)}i.length===0?o.style.display="none":o.style.removeProperty("display");let r=this.element.querySelector(".modal-close");r.onclick=()=>this.close(),t?.allowClose?r.style.removeProperty("display"):r.style.display="none"}static makeHtmlElement(){let e=document.createElement("div");e.className="modal-dialog",e.style.display="none";let t=document.createElement("div");t.className="modal-content",e.appendChild(t);let n=document.createElement("div");n.className="modal-header",t.appendChild(n);let s=document.createElement("div");s.className="modal-title",n.appendChild(s);let o=document.createElement("div");o.className="modal-close",o.innerHTML="&times;",n.appendChild(o);let i=document.createElement("div");i.className="modal-body",t.appendChild(i);let r=document.createElement("div");return r.className="modal-footer",t.appendChild(r),e}show(){this.element.style.removeProperty("display")}hide(){this.element.style.display="none"}close(){this.hide(),this.onClose&&this.onClose()}};var le=class{constructor(){this.orderedTasks=[];this.canvas=null;this.selectionBoxElement=null;this.contextMenuElement=null;this.taskMap=new Map;this.dependencyMap=new Map;this.canvas=document.getElementById("canvas"),x.init(this.canvas),this.contextMenuElement=document.getElementById("contextMenu"),this.contextMenuElement||(this.contextMenuElement=document.createElement("div"),this.contextMenuElement.id="contextMenu",this.contextMenuElement.style.position="absolute",this.contextMenuElement.style.display="none",document.body.appendChild(this.contextMenuElement));let e=document.createElement("div");e.id="modalScreen",e.style.position="fixed",e.style.inset="0",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.display="none",e.style.zIndex="1000",document.body.appendChild(e),this.modalDialogElement=W.makeHtmlElement(),this.modalDialogElement.style.zIndex="1001",document.body.appendChild(this.modalDialogElement),this.modalScreen=e}pauseCanvas(){this.modalScreen.style.display="block"}unpauseCanvas(){this.modalScreen.style.display="none"}showModal(e,t,n){return new Promise(s=>{new W(this.modalDialogElement,{title:e,message:t,options:n,allowClose:!1,onSelection:i=>{s(i)}}).show()})}getCanvasPan(){let e=x.getTranslation();return D.new(e.x,e.y)}setCanvasPan(e){x.setTranslation(e.vec)}getTaskPositionOnCanvas(e){let t=this.getTaskElement(e);if(!t)throw new Error("Task element not found");return w.new(t.offsetLeft,t.offsetTop)}toggleTaskHighlight(e,t){let n=this.getTaskElement(e);n&&(t?n.classList.add("selected"):n.classList.remove("selected"))}toggleAllTaskHighlights(e){(this.canvas?.querySelectorAll(".task")).forEach(n=>{e?n.classList.add("selected"):n.classList.remove("selected")})}showSelectionBox(){if(!this.canvas)throw new Error("Canvas not initialized");this.selectionBoxElement||(this.selectionBoxElement=document.createElement("div"),this.selectionBoxElement.style.position="absolute",this.selectionBoxElement.style.border="1px dashed lightblue",this.selectionBoxElement.style.backgroundColor="rgba(173,216,230,0.2)",this.selectionBoxElement.style.pointerEvents="none",this.canvas.appendChild(this.selectionBoxElement))}moveSelectionBox(e,t){if(!this.selectionBoxElement)return;let n=Math.min(e.x,t.x),s=Math.min(e.y,t.y),o=x.getScale(),i=x.getTranslation();n=(n-i.x)/o,s=(s-i.y)/o;let r=Math.abs(e.x-t.x)/o,u=Math.abs(e.y-t.y)/o;this.selectionBoxElement.style.left=n+"px",this.selectionBoxElement.style.top=s+"px",this.selectionBoxElement.style.width=r+"px",this.selectionBoxElement.style.height=u+"px"}hideSelectionBox(){this.selectionBoxElement&&(this.selectionBoxElement.remove(),this.selectionBoxElement=null)}getAllTasks(){return Array.from(this.taskMap.values()).map(e=>e.task)}getTasksInArea(e,t){if(!this.canvas)throw new Error("Canvas not initialized");let n=N.fromPoints(e,t),s=[];return this.canvas.querySelectorAll(".task").forEach(i=>{let r=N.fromElementBounds(i);if(n.intersects(r)){let u=i.getAttribute("data-id"),p=u?parseInt(u):null;p&&this.taskMap.has(p)&&s.push(this.taskMap.get(p).task)}}),s}showContextMenu(e,t){let n=this.contextMenuElement;if(!n)throw new Error("Not initialized");n.innerHTML="",t.forEach(s=>{let o=document.createElement("div");o.textContent=s[1],o.setAttribute("data-role","context-menu-item"),o.setAttribute("data-key",s[0]),n.appendChild(o)}),n.style.left=e.x+"px",n.style.top=e.y+"px",n.style.display="block"}hideContextMenu(){this.contextMenuElement&&(this.contextMenuElement.style.display="none")}addTaskToCanvas(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=document.createElement("div");t.classList.add("task"),t.setAttribute("data-id",e.getId().toString());let n=e.getPosition();n&&(t.style.left=n.x+"px",t.style.top=n.y+"px",t.setAttribute("data-snapped",n.x%40===0&&n.y%40===0?"true":"false"));let s=document.createElement("div");s.classList.add("task-header");let o=document.createElement("div");o.setAttribute("data-role","expand-switch"),o.classList.add("expand-switch"),e.isExpanded()?o.classList.add("expand-switch-expanded"):e.getDescription().length===0&&o.classList.add("expand-switch-add"),s.appendChild(o);let i=document.createElement("div");i.classList.add("title"),i.setAttribute("data-role","title"),i.textContent=e.getTitle(),s.appendChild(i);let r=document.createElement("div");r.classList.add("custom-checkbox"),r.setAttribute("data-role","checkbox");let u=document.createElement("div");u.classList.add("checkbox-fill"),u.innerHTML=`
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" style="background: transparent;">
  <rect x="1" y="1" width="26" height="26" rx="3.75" ry="3.75" fill="none" stroke="#4d4d4d" stroke-width="2"></rect>
  <defs>
    <mask id="checkMask-${e.getId()}">
      <rect x="0" y="0" width="28" height="28" fill="white"></rect>
      <polyline points="8,15 12,19 20,9" stroke="black" stroke-width="2" stroke-linecap="round" fill="none" stroke-linejoin="round"></polyline>
    </mask>
  </defs>
  <rect x="4" y="4" width="20" height="20" rx="1.9" ry="1.9" fill="#25a599" fill-opacity="${e.isComplete()?"1":"0.1"}" mask="url(#checkMask-${e.getId()})"></rect>
</svg>`,r.appendChild(u),s.appendChild(r),t.appendChild(s);let p=document.createElement("div");p.classList.add("task-body"),p.style.display=e.isExpanded()?"block":"none",t.appendChild(p);let f=document.createElement("div");f.classList.add("description"),f.setAttribute("data-role","description"),f.innerHTML=e.getDescription(),p.appendChild(f),n&&this.adjustTaskZPositionInternal(t,n),this.taskMap.set(e.getId(),{task:e,element:t})}moveTask(e,t,n=!0){let s=this.taskMap.get(e.getId());if(!s)return;let o=s.element;o.style.left=t.x+"px",o.style.top=t.y+"px",n&&this.adjustTaskZPositionInternal(o,t)}adjustTaskZPosition(e,t){let n=this.taskMap.get(e.getId());n&&this.adjustTaskZPositionInternal(n.element,t)}adjustTaskZPositionInternal(e,t){let n=this.orderedTasks.find(o=>o.element===e);n?(n.position=t,this.orderedTasks=this.orderedTasks.filter(o=>o.element!==e)):n={id:parseInt(e.getAttribute("data-id")||"-1"),element:e,position:t};let s=this.orderedTasks.findIndex(o=>t.y>o.position.y||t.y===o.position.y&&t.x>o.position.x);if(s===-1&&(s=this.orderedTasks.length),this.orderedTasks.splice(s,0,n),!this.canvas)throw new Error("Canvas not initialized");s===this.orderedTasks.length-1?this.canvas.appendChild(e):this.canvas.insertBefore(e,this.orderedTasks[s+1].element)}toggleEditModeForTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="title"]'),i=o instanceof HTMLInputElement?o:null;if(t)i||(i=document.createElement("input"),i.dataset.role="title",i.type="text",i.value=o.textContent||"",i.style.width="100%",o.replaceWith(i),i.focus());else if(i){let r=document.createElement("div");r.dataset.role="title",r.classList.add("title"),r.textContent=i.value,i.replaceWith(r)}}getTaskTitle(e){let t=this.taskMap.get(e.getId());if(!t)return"";let s=t.element.querySelector('[data-role="title"]'),o=s instanceof HTMLInputElement?s:null;return o?o.value:s.textContent||""}setTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="title"]'),i=o instanceof HTMLInputElement?o:null;i?i.value=t:o.textContent=t}toggleEditModeForTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let o=n.element.querySelector('[data-role="description"]');if(t){if(o&&o.classList.contains("editor-container"))return;let i=o?o.innerHTML:"",r=document.createElement("div");r.classList.add("editor-container"),r.setAttribute("data-role","description"),r.style.minHeight="50px";let u=document.createElement("div");r.appendChild(u),o&&o.parentNode&&o.parentNode.replaceChild(r,o);let p=new Quill(u,{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{color:[]},{background:[]}],[{align:[]}],["clean"]]}});p.root.innerHTML=i,p.focus(),setTimeout(()=>p.setSelection(p.getLength(),0),0);let f=()=>{let l=p.root.scrollHeight;u.style.height=l+"px"};p.on("text-change",f),f(),r._quill=p}else{if(!o||!o.classList.contains("editor-container"))return;let i=o._quill;if(!i)return;let r=i.root.innerHTML;r==="<p><br></p>"&&(r="");let u=document.createElement("div");u.classList.add("description"),u.setAttribute("data-role","description"),u.innerHTML=r,o.parentNode?.replaceChild(u,o)}}getTaskDescription(e){let t=this.taskMap.get(e.getId());if(!t)return null;let s=t.element.querySelector('[data-role="description"]');if(!s)return null;if(s.classList.contains("editor-container")){let o=s._quill;if(!o)return null;let i=o.root.innerHTML;return i==="<p><br></p>"&&(i=""),i}else return s.innerHTML}setTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let s=n.element,o=s.querySelector('[data-role="description"]');if(o){if(o.classList.contains("editor-container")){let i=o._quill;i&&(i.root.innerHTML=t||"<p><br></p>")}else if(o.innerHTML=t,t.length===0){let i=s.querySelector('[data-role="expand-switch"]');i&&i.classList.add("expand-switch-add")}}}toggleTaskCompletion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let s=n.querySelector(".checkbox-fill");if(s){let o=s.querySelector("rect[mask]");o&&o.setAttribute("fill-opacity",t?"1":"0.1")}}toggleTaskExpansion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let s=n.querySelector(".task-body");s&&(s.style.display=t?"none":"block");let o=n.querySelector('[data-role="expand-switch"]');o&&(t?(o.classList.remove("expand-switch-expanded"),e.getDescription().length===0?o.classList.add("expand-switch-add"):o.classList.remove("expand-switch-add")):(o.classList.add("expand-switch-expanded"),o.classList.remove("expand-switch-add")))}removeTask(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=this.taskMap.get(e.getId());t&&(t.element.remove(),this.taskMap.delete(e.getId()));let n=this.orderedTasks.findIndex(s=>s.id===e.getId());n!==-1&&this.orderedTasks.splice(n,1)}addDependency(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=e.getRequiredTask(),n=e.getRequiredByTask(),s=this.dependencyKey(t.getId(),n.getId()),o=new X(this,t,n,e,s,this.canvas);return this.dependencyMap.set(s,o),o}removeDependency(e){let t=this.dependencyKey(e.getRequiredTask().getId(),e.getRequiredByTask().getId()),n=this.dependencyMap.get(t);n&&(n.remove(),this.dependencyMap.delete(t))}createArrow(e,t){if(!this.canvas)throw new Error("Canvas not initialized");return new X(this,e,t,null,null,this.canvas)}updateArrow(e,t){if(!(e instanceof X))throw new Error("Invalid arrow");let n=e;if(n.update(t?.source||null,t?.target||null),t?.isGhostArrow){let s=t.source?t.source:n.getSource(),o=t.target?t.target:n.getTarget(),p=s instanceof w||o instanceof w?"#b3555588":"#55b38888";n.setColor(p)}else n.setColor(X.defaultColor)}removeArrow(e){e.remove()}getTaskInfo(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id"),s=n?parseInt(n):null;if(!s||!this.taskMap.has(s))return null;let o=this.taskMap.get(s).task;return e.closest('[data-role="title"]')?{task:o,component:"title"}:e.closest('[data-role="description"]')?{task:o,component:"description"}:e.closest('[data-role="expand-switch"]')?{task:o,component:"collapse"}:e.closest('[data-role="checkbox"]')?{task:o,component:"completion"}:e.closest(".task-header")?{task:o,component:"header"}:{task:o,component:"task"}}getTask(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id"),s=n?parseInt(n):null;return s?this.taskMap.get(s).task:null}getDependency(e){let t=e.closest('[data-role="dependency-arrow"]');if(!t)return null;let n=t.getAttribute("data-id");return n&&this.dependencyMap.get(n)?.dependency||null}getContextMenuOption(e){if(!e)return null;let t=e.closest('[data-role="context-menu-item"]');return t?t.getAttribute("data-key"):null}getTaskElement(e){let t=this.taskMap.get(e.getId());return t?t.element:null}getTaskElementFromChild(e){return e.closest(".task")}dependencyKey(e,t){return e+"->"+t}},X=class a{constructor(e,t,n,s,o,i){this.presenter=e;this.dependency=s;this.source=this.setSource(t),this.target=this.setTarget(n),this.arrow=ve.createArrow(i,this.getArrowSource(),this.getArrowTarget(),{color:a.defaultColor,dataId:o||void 0}),i.prepend(this.arrow.svg)}static{this.defaultColor="#b3b3b3"}getSource(){return this.source instanceof w?this.source:this.source.task}setSource(e){if(e instanceof w)this.source=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid source");this.source=new ce(e,t)}return this.source}getArrowSource(){if(this.source instanceof w)return this.source.vec;if(this.source.element)return N.fromElementBounds(this.source.element).toCanvasRect().rect;throw new Error("Invalid source")}getTarget(){return this.target instanceof w?this.target:this.target.task}setTarget(e){if(e instanceof w)this.target=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid target");this.target=new ce(e,t)}return this.target}getArrowTarget(){if(this.target instanceof w)return this.target.vec;if(this.target.element)return N.fromElementBounds(this.target.element).toCanvasRect().rect;throw new Error("Invalid target")}update(e,t){e&&this.setSource(e),t&&this.setTarget(t);let n=this.getArrowSource(),s=this.getArrowTarget();this.arrow.update(n,s)}setColor(e){this.arrow.setColor(e)}remove(){this.arrow.remove()}},ce=class{constructor(e,t){this.task=e;this.element=t}};var de=class{constructor(){this.CLIENT_ID="834406545740-fpa6k2omak75t15u8ve4t7n0t3r1r0ig.apps.googleusercontent.com";this.API_KEY="AIzaSyCMJf3NuTEBASgWaXTQhy6fiM9QY0GAitg";this.DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];this.SCOPES="https://www.googleapis.com/auth/drive";this.tokenClient=null;this.accessToken=null;this.init()}init(){gapi.load("client",()=>{gapi.client.init({apiKey:this.API_KEY,discoveryDocs:this.DISCOVERY_DOCS}).then(()=>{console.log("GAPI client initialized.")}).catch(e=>{console.error("Error initializing GAPI client:",e)})}),this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:this.CLIENT_ID,scope:this.SCOPES,callback:e=>{e.error?console.error("Error during token acquisition:",e.error):(this.accessToken=F.fromResponse(e),console.log("Access token acquired:",this.accessToken.token))}})}tryAutoSignIn(){let e=F.getExisting();return e?(this.accessToken=e,!0):!1}signIn(){return new Promise((e,t)=>{if(!this.tokenClient)return t(new Error("Token client not initialized."));let n=this.tokenClient.callback;this.tokenClient.callback=s=>{s.error?(console.error("Sign-in error:",s.error),e(!1)):(this.accessToken=F.fromResponse(s),console.log("User signed in, token:",this.accessToken.token),e(!0)),this.tokenClient.callback=n},this.tokenClient.requestAccessToken()})}async getAccessTokenValidFor(e){let t=this.accessToken||F.getExisting();if(t&&!t.expiresWithin(e))return t;for(;;)if(await this.signIn(),this.accessToken?.expiresWithin(e)===!1)return this.accessToken}pickFolder(){return new Promise(e=>{gapi.load("picker",async()=>{let t=new google.picker.DocsView(google.picker.ViewId.FOLDERS).setParent("root").setMode(google.picker.DocsViewMode.LIST).setSelectFolderEnabled(!0),n=await this.getAccessTokenValidFor(60);new google.picker.PickerBuilder().addView(t).setOAuthToken(n.token).setDeveloperKey(this.API_KEY).setCallback(o=>{if(o.action===google.picker.Action.PICKED){let i=o.docs[0].id;e(i)}else o.action===google.picker.Action.CANCEL&&e(null)}).build().setVisible(!0)})})}pickFile(e){let t=Array.isArray(e)?e.length>0?e.join(","):void 0:e;return new Promise(n=>{gapi.load("picker",async()=>{let s=new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(!0).setParent("root").setMode(google.picker.DocsViewMode.LIST);t&&s.setMimeTypes(t);let o=await this.getAccessTokenValidFor(60);new google.picker.PickerBuilder().addView(s).setOAuthToken(o.token).setDeveloperKey(this.API_KEY).setCallback(r=>{if(r.action===google.picker.Action.PICKED){let u=r.docs[0].id;n(u)}else r.action===google.picker.Action.CANCEL&&n(null)}).build().setVisible(!0)})})}saveAs(e,t,n,s){return new Promise(async o=>{let i=new Blob([n],{type:s}),r={name:e,mimeType:s};t!=="root"&&(r.parents=[t]);let u=new FormData;u.append("metadata",new Blob([JSON.stringify(r)],{type:"application/json"})),u.append("file",i);let p=await this.getAccessTokenValidFor(20);fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{method:"POST",headers:new Headers({Authorization:"Bearer "+p.token}),body:u}).then(f=>f.json()).then(f=>{o(f.id)}).catch(f=>{console.error("Error creating file:",f),o(null)})})}save(e,t,n){return new Promise(async s=>{let o=await this.getAccessTokenValidFor(20);fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:new Headers({Authorization:"Bearer "+o.token,"Content-Type":n||"text/plain"}),body:t}).then(()=>s()).catch(i=>{console.error("Error saving file:",i),s()})})}open(e){return new Promise(async t=>{let n=await this.getAccessTokenValidFor(20);fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:new Headers({Authorization:"Bearer "+n.token})}).then(s=>s.text()).then(s=>t(s)).catch(s=>{console.error("Error opening file:",s),t(null)})})}},F=class a{constructor(e,t,n){this.token=e;this.expires=t;n&&(localStorage.setItem(a.TOKEN_KEY,e),localStorage.setItem(a.EXPIRY_KEY,t.toISOString()))}static{this.TOKEN_KEY="googleAccessToken"}static{this.EXPIRY_KEY="googleAccessTokenExpires"}static getExisting(){let e=localStorage.getItem(a.TOKEN_KEY);if(!e)return null;let t=localStorage.getItem(a.EXPIRY_KEY);if(!t)return null;try{let n=new Date(t);return n.getTime()-Date.now()<=6e4?null:new a(e,n,!1)}catch{return null}}static fromResponse(e){if(!e.access_token||!e.expires_in)throw new Error(`Invalid access token response: ${JSON.stringify(e)}`);let t=e.access_token,n=new Date(Date.now()+e.expires_in*1e3);return new a(t,n,!0)}expiresWithin(e){return this.expires.getTime()-Date.now()<=e*1e3}};var $=class{constructor(e,t,n){this._service=e,this.fileId=t,this.mimeType=n,this.canvasData=new j}get locationId(){return this.fileId}async retrieveCanvasData(){let e=await this._service.open(this.fileId),t=e?JSON.parse(e):void 0;return this.canvasData=new j(t),t??this.canvasData.toStorageModel()}saveCanvasData(e){return this.canvasData=new j(e),this.save()}saveTask(e){return this.canvasData.addOrUpdateTask(new Y(e)),this.save()}async deleteTask(e){return this.canvasData.removeTask(new Y(e))?(await this.save(),!0):!1}async saveDependency(e){this.canvasData.addDependency(e)&&await this.save()}async deleteDependency(e){return this.canvasData.removeDependency(e)?(await this.save(),!0):!1}async saveMany(e){let t=!1;for(let n of e){let[s,o]=this.resolveDataModel(n);s?t=this.canvasData.addOrUpdateTask(new Y(s))||t:o&&(t=this.canvasData.addDependency(o)||t)}t&&await this.save()}async deleteMany(e){let t=!1;for(let n of e){let s=n;s.title||(s=void 0);let o=n;(s||!o.requiredTaskId)&&(o=void 0),s?t=this.canvasData.removeTask(new Y(s))||t:o&&(t=this.canvasData.removeDependency(o)||t)}t&&await this.save()}resolveDataModel(e){let t=e;t.title||(t=void 0);let n=e;return(t||!n.requiredTaskId)&&(n=void 0),[t,n]}async save(){let e=JSON.stringify(this.canvasData.toStorageModel(),null,2);return this._service.save(this.fileId,e,this.mimeType)}},j=class{constructor(e){this.version=e?.version||"1.0",this.taskMap=e?.tasks?new Map(e.tasks.map(t=>[t.id,new Y(t)])):new Map,this.depMap=e?.dependencies?new Map(e.dependencies.map(t=>[`${t.requiredTaskId}->${t.requiredByTaskId}`,t])):new Map,this.pan=e?.pan||{x:0,y:0},this.zoom=e?.zoom||1}addOrUpdateTask(e){return this.taskMap.set(e.id,e),!0}removeTask(e){return this.taskMap.delete(e.id)}addDependency(e){let t=`${e.requiredTaskId}->${e.requiredByTaskId}`;return this.depMap.has(t)?!1:(this.depMap.set(t,e),!0)}removeDependency(e){return this.depMap.delete(`${e.requiredTaskId}->${e.requiredByTaskId}`)}toStorageModel(){return{version:this.version,tasks:[...this.taskMap.values()],dependencies:[...this.depMap.values()],pan:this.pan,zoom:this.zoom}}},Y=class{constructor(e){this.id=e.id,this.title=e.title,this.description=e.description,this.completed=e.completed,this.position={x:e.position.x,y:e.position.y},this.collapsed=e.collapsed}};var ue="application/vnd.taskcanvas+json",pe=class a{constructor(){this.signedIn=!1;a._service??=new de,this._service=a._service}get uniqueName(){return"g"}async requestAuthentication(){return!this.signedIn&&(this.signedIn=this._service.tryAutoSignIn(),this.signedIn)?!0:(this.signedIn=await this._service.signIn(),this.signedIn)}async requestConnection(e){if(e){let t=confirm(`Do you want to choose a folder for your new task canvas file?

Click OK for folder selection, or Cancel to use the root folder.`),n="root";if(t&&(n=await this._service.pickFolder(),!n))return null;let s=prompt("Enter the file name for the new canvas file (e.g., mycanvas.tc):");if(!s)return null;s.endsWith(".tc")||(s+=".tc");let o={version:"1.0",tasks:[],dependencies:[],pan:{x:0,y:0},zoom:1},i=await this.createNewFile(s,n,o);return i?new $(this._service,i,ue):null}else{let n=await this._service.pickFile(ue);return n?new $(this._service,n,ue):null}}async requestConnectionToLocation(e){return new $(this._service,e,ue)}createNewFile(e,t,n){return this._service.saveAs(e,t,JSON.stringify(n,null,2))}};document.addEventListener("DOMContentLoaded",()=>{let a=new le,e=new pe,t=new oe,n=new se(a,[e],t),s=new ae(n,a);n.pauseCanvas(),o().then(()=>n.load());async function o(){let i=null,r=t.getStorageLocation();for(r&&(i=await n.requestConnectionToStorageLocation(r));!i;)i=await n.requestConnectionToStorage(!1)}});})();
//# sourceMappingURL=app.js.map
