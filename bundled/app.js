"use strict";(()=>{var Q=class{constructor(){this.map=new Map}set(e,t,n){let o=this.map.get(e);o||(o=new Map,this.map.set(e,o)),o.set(t,n)}get(e,t){let n=this.map.get(e);return n?n.get(t):void 0}delete(e,t){let n=this.map.get(e),o=!1;return n&&(o=n.delete(t),n.size===0&&this.map.delete(e)),o}has(e,t){let n=this.map.get(e);return n?n.has(t):!1}clear(){this.map.clear()}getKeys1(){return this.map.keys()}getKeys2(e){let t=this.map.get(e);return t?t.keys():[].values()}getValues(){let e=[];for(let t of this.map.values())for(let n of t.values())e.push(n);return e.values()}getEntries(){let e=[];for(let[t,n]of this.map)for(let[o,s]of n)e.push([t,o,s]);return e.values()}};var g=class i{constructor(e,t){this.x=e;this.y=t}static{this.zero=new i(0,0)}static{this.identity=new i(1,1)}static{this.up=new i(0,-1)}static{this.down=new i(0,1)}static{this.left=new i(-1,0)}static{this.right=new i(1,0)}lenSqr(){return this.x*this.x+this.y*this.y}add(e){return new i(this.x+e.x,this.y+e.y)}sub(e){return new i(this.x-e.x,this.y-e.y)}mul(e){return new i(this.x*e,this.y*e)}div(e){return new i(this.x/e,this.y/e)}translate(e,t){return new i(this.x+e,this.y+t)}negate(){return new i(-this.x,-this.y)}normalize(){let e=this.lenSqr();if(e===0)return i.zero;let t=1/Math.sqrt(e);return new i(this.x*t,this.y*t)}dot(e){return this.x*e.x+this.y*e.y}},I=class i{constructor(e,t){this.position=e;this.size=t}static fromBounds(e){return new i(new g(e.left,e.top),new g(e.right-e.left,e.bottom-e.top))}static fromPoints(e,t){return new i(new g(Math.min(e.x,t.x),Math.min(e.y,t.y)),new g(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}get left(){return this.position.x}get right(){return this.position.x+this.size.x}get top(){return this.position.y}get bottom(){return this.position.y+this.size.y}get width(){return this.size.x}get height(){return this.size.y}scale(e,t){return new i(this.position.sub(t).mul(e).add(t),this.size.mul(e))}contains(e){return e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom}intersects(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}};var x=class{static{this.minScale=.25}static{this.maxScale=2}static{this.canvas=null}static{this.scale=1}static{this.translation=g.zero}static init(e){this.canvas=e,this.canvas.style.transformOrigin="0 0",this.canvas.style.cursor="default",this.updateTransform(),(this.canvas.parentElement||this.canvas).addEventListener("wheel",t=>this.onWheel(t),{passive:!1})}static updateTransform(){this.canvas&&(this.canvas.style.transform=`translate(${this.translation.x}px, ${this.translation.y}px) scale(${this.scale})`)}static onWheel(e){if(e.preventDefault(),e.ctrlKey){let t=e.deltaY<0?.1:-.1,n=new g(e.clientX,e.clientY);this.setScale(this.scale+t,n)}else{let t=new g(e.deltaX,e.deltaY);this.translation=this.translation.sub(t),this.updateTransform()}}static setScale(e,t){if(e=Math.max(this.minScale,Math.min(this.maxScale,e)),e!==this.scale&&this.canvas){let n=e/this.scale;this.translation=this.translation.mul(n).add(t.mul(1-n)),this.scale=e,this.updateTransform()}}static panBy(e){this.translation=this.translation.add(e),this.updateTransform()}static getScale(){return this.scale}static getTranslation(){return this.translation}};var H=class i{constructor(e){this.vec=e}static new(e,t){return new i(new g(e,t))}static fromEvent(e){return i.new(e.clientX,e.clientY)}static{this.zero=new i(g.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}subtractCoords(e){return new q(this.vec.sub(e.vec))}toCanvasCoords(){let e=x.getScale(),t=x.getTranslation();return y.new((this.x-t.x)/e,(this.y-t.y)/e)}},q=class i{constructor(e){this.vec=e}static new(e,t){return new i(new g(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}toCanvasSize(){let e=x.getScale?x.getScale():1;return new $(this.vec.div(e))}},G=class i{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new I(e.vec,t.vec)}static fromElementBounds(e){let t=e.getBoundingClientRect();return new i(H.new(t.left,t.top),q.new(t.width,t.height))}static fromPoints(e,t){return new i(H.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),q.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toCanvasRect(){return new ie(this.position.toCanvasCoords(),this.size.toCanvasSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}},y=class i{constructor(e){this.vec=e}static new(e,t){return new i(new g(e,t))}static{this.zero=new i(g.zero)}get x(){return this.vec.x}get y(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}subtractCoords(e){return new $(this.vec.sub(e.vec))}toScreenCoords(){let e=x.getScale?x.getScale():1,t=x.getTranslation();return H.new(this.x*e+t.x,this.y*e+t.y)}},$=class i{constructor(e){this.vec=e}static new(e,t){return new i(new g(e,t))}get width(){return this.vec.x}get height(){return this.vec.y}add(e){return new i(this.vec.add(e.vec))}sub(e){return new i(this.vec.sub(e.vec))}toScreenSize(){let e=x.getScale?x.getScale():1;return new q(this.vec.mul(e))}},ie=class i{constructor(e,t,n){this.position=e;this.size=t;this.rect=n??new I(e.vec,t.vec)}static fromPoints(e,t){return new i(y.new(Math.min(e.x,t.x),Math.min(e.y,t.y)),$.new(Math.abs(e.x-t.x),Math.abs(e.y-t.y)))}toScreenRect(){return new G(this.position.toScreenCoords(),this.size.toScreenSize())}contains(e){return this.rect.contains(e.vec)}intersects(e){return this.rect.intersects(e.rect)}};var M=class i{constructor(e={}){this.requiredDependencies=new Map;this.requiredByDependencies=new Map;this.id=e.id||`task-${i.taskIdCounter++}`,this.title=e.title||"New Task",this.description=e.description||"<p>Description</p>",this.position=e.position||null,this.completed=e.completed||!1,this.collapsed=e.collapsed||!1}static{this.taskIdCounter=0}getId(){return this.id}getTitle(){return this.title}getDescription(){return this.description}isComplete(){return this.completed}getRequired(){return this.requiredDependencies}getRequiredBy(){return this.requiredByDependencies}getPosition(){return this.position}isExpanded(){return!this.collapsed}};var O=class{constructor(e,t){this.requiredTask=e;this.requiredByTask=t}getRequiredTask(){return this.requiredTask}getRequiredByTask(){return this.requiredByTask}};var B=new Map,Y=new Q;var _=class{constructor(e){this.presenter=e}createTask(e){let t=new M({position:e});return B.set(t.id,t),this.presenter.addTaskToCanvas(t),this.pushUndo({type:"addTask",task:t}),this.save(),t}toggleTaskCompletion(e,t){let n=e instanceof M?e:B.get(e.getId());if(!n)throw new Error("Task does not exist");n.completed=t===null?!n.completed:t,this.presenter.toggleTaskCompletion(n,n.completed),this.pushUndo({type:"toggleComplete",taskId:n.id,newValue:n.completed,oldValue:!n.completed}),this.save()}toggleTaskExpansion(e,t){let n=e instanceof M?e:B.get(e.getId());if(!n)throw new Error("Task does not exist");n.collapsed=t===null?!n.collapsed:!t,this.presenter.toggleTaskExpansion(n,n.collapsed),this.pushUndo({type:"toggleCollapse",taskId:n.id,newValue:n.collapsed,oldValue:!n.collapsed}),this.save()}changeTaskTitle(e,t){let n=e instanceof M?e:B.get(e.getId());if(!n)throw new Error("Task does not exist");let o=n.title;n.title=t,this.presenter.setTaskTitle(n,t),this.pushUndo({type:"editTask",taskId:n.id,field:"title",newTitle:t,oldTitle:o}),this.save()}changeTaskDescription(e,t){let n=e instanceof M?e:B.get(e.getId());if(!n)throw new Error("Task does not exist");let o=n.description;n.description=t,this.presenter.setTaskDescription(n,t),this.pushUndo({type:"editTask",taskId:n.id,field:"description",newDescription:t,oldDescription:o}),this.save()}moveTasks(e){let t=[];e.forEach(n=>{let{task:o,position:s}=n,r=o instanceof M?o:B.get(o.getId());if(!r)throw new Error("Task does not exist");let p=r.getPosition()||y.zero;r.position=s,this.presenter.moveTask(r,s),r.requiredByDependencies.forEach(c=>{let k=c instanceof O?c:Y.get(c.getRequiredTask().getId(),c.getRequiredByTask().getId());k?.arrow&&this.presenter.updateArrow(k.arrow)}),r.requiredDependencies.forEach(c=>{let k=c instanceof O?c:Y.get(c.getRequiredTask().getId(),c.getRequiredByTask().getId());k?.arrow&&this.presenter.updateArrow(k.arrow)}),t.push({taskId:r.getId(),oldPosition:p,newPosition:s})}),this.pushUndo({type:"moveTasks",taskMovements:t}),this.save()}deleteTasks(e){let t=e.map(o=>{let s=o instanceof M?o:B.get(o.getId());if(!s)throw new Error("Task does not exist");return s}),n=new Set;for(let o of t)this.presenter.removeTask(o),B.delete(o.getId()),o.requiredByDependencies.forEach(s=>{let r=s instanceof O?s:Y.get(s.getRequiredTask().getId(),s.getRequiredByTask().getId());!r||n.has(r)||(this.deleteDependency(r,!1,!0),n.add(r))}),o.requiredDependencies.forEach(s=>{let r=s instanceof O?s:Y.get(s.getRequiredTask().getId(),s.getRequiredByTask().getId());!r||n.has(r)||(this.deleteDependency(r,!1,!0),n.add(r))});this.pushUndo({type:"deleteTasks",tasks:t,dependencies:[...n]})}createDependency(e,t){if(e.getRequired().has(t.getId()))return e.getRequired().get(t.getId());let n=e instanceof M?e:B.get(e.getId());if(!n)throw new Error("Required task does not exist");let o=t instanceof M?t:B.get(t.getId());if(!o)throw new Error("Required by task does not exist");let s=new O(n,o);Y.set(n.id,o.id,s),n.requiredByDependencies.set(o.id,s),o.requiredDependencies.set(n.id,s);let r=this.presenter.addDependency(s);return s.arrow=r,this.pushUndo({type:"addDependency",from:n.getId(),to:o.getId()}),this.save(),s}deleteDependency(e,t=!0,n=!1){let o=e instanceof O?e:Y.get(e.getRequiredTask().getId(),e.getRequiredByTask().getId());if(o){let s=o.getRequiredTask(),r=o.getRequiredByTask();if(t){let p=s instanceof M?s:B.get(s.getId());if(!p)throw new Error("Required task does not exist");let c=r instanceof M?r:B.get(r.getId());if(!c)throw new Error("Required by task does not exist");p.requiredByDependencies.delete(c.getId()),c.requiredDependencies.delete(p.getId())}Y.delete(s.getId(),r.getId()),this.presenter.removeDependency(o),n||this.pushUndo({type:"deleteDependency",from:s.getId(),to:r.getId()}),this.save()}}undo(){throw new Error("Method not implemented.")}redo(){throw new Error("Method not implemented.")}pushUndo(e){}save(){}};var ae=function(){let i=null,e=null,t=null,n=null,o=!1,s=!1,r=5,p=200,c=!1;function k(h){h.button===0?(e=h,o=!1):h.button===2&&(t=h,s=!1)}function A(h){if(u(d("mousemove",h)),e&&!o){let l=h.clientX-e.clientX,m=h.clientY-e.clientY;Math.sqrt(l*l+m*m)>r&&(o=!0,u(d("mousedown",e)))}if(t&&!s){let l=h.clientX-t.clientX,m=h.clientY-t.clientY;Math.sqrt(l*l+m*m)>r&&(s=!0,u(d("mousedown",t)))}}function a(h){let l=Date.now();h.button===0?(o?u(d("mouseup",h)):n&&l-n.time<p?(u(d("dblclick",h)),n=null):(n={event:h,time:l},setTimeout(()=>{n&&Date.now()-n.time>=p&&(u(d("click",h)),n=null)},p)),e=null,o=!1):h.button===2?(u(d(s?"mouseup":"contextmenu",h)),t=null,s=!1):u(d("mouseup",h))}function d(h,l){return{type:h,button:l.button,clientX:l.clientX,clientY:l.clientY,pageX:l.pageX!==void 0?l.pageX:l.clientX+window.scrollX,pageY:l.pageY!==void 0?l.pageY:l.clientY+window.scrollY,target:l.target,originalEvent:l}}function u(h){if(typeof i=="function")try{i(h)}catch(l){console.error("InputInterpreter callback error:",l)}}function v(h){if(typeof h!="function")throw new Error("MouseInputInterpreter.init requires a callback function");i=h,c||(document.addEventListener("mousedown",k),document.addEventListener("mousemove",A),document.addEventListener("mouseup",a),c=!0)}function b(){c&&(document.removeEventListener("mousedown",k),document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",a),c=!1),i=null,e=null,t=null,n=null,o=!1,s=!1}return{init:v,destroy:b}}();var J=class{constructor(){this.mousePosition=H.zero;this.mouseMovement=new q(g.zero);this.leftPressed=!1;this.rightPressed=!1;this.middlePressed=!1;this.leftDownScreenPosition=H.zero;this.rightDownScreenPosition=H.zero;this.middleDownScreenPosition=H.zero;this.leftDownCanvasPosition=null;this.rightDownCanvasPosition=null;this.middleDownCanvasPosition=null;this.keys={};this.lastEvent=null;this.target=null;this.taskInTitleEditMode=null;this.taskInDescriptionEditMode=null;this.taskHeldByMouse=null;this.taskHeldByMouseOriginalCanvasPosition=y.zero;this.taskHeldByMouseCurrentCanvasPosition=y.zero;this.selectedTasks=new Set;this.selectionBoxStart=H.zero;this.contextMenuContext=null;this.dependencyCreationContext=null;this.taskTitleEditContext=null;this.taskDescriptionEditContext=null;this.canvasPanningContext=null;this.mouseIsHoldingDependencyArrow=!1;this.mouseIsHoldingSingleTask=!1;this.mouseIsHoldingTaskGroup=!1;this.mouseIsHoldingCanvas=!1;this.mouseIsDrawingSelectionBox=!1}};var D=40,ee=6,te=class{constructor(e,t){this.controlState=new J;this.app=e,this.presenter=t,this.init()}init(){document.addEventListener("contextmenu",e=>{e.preventDefault()},!0),ae.init(e=>{this.updateControlState(e)}),["keydown","keyup"].forEach(e=>{document.addEventListener(e,t=>this.updateControlState(t))})}updateControlState(e){this.controlState.lastEvent=e,e.clientX!==void 0&&e.clientY!==void 0&&(this.controlState.mousePosition=H.new(e.clientX,e.clientY)),this.controlState.mouseMovement=q.new(e.movementX||0,e.movementY||0),this.controlState.target=e.target,e.type==="mousedown"?e.button===0?(this.controlState.leftPressed=!0,this.controlState.leftDownScreenPosition=this.controlState.mousePosition,this.controlState.leftDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===2?(this.controlState.rightPressed=!0,this.controlState.rightDownScreenPosition=this.controlState.mousePosition,this.controlState.rightDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.button===1&&(this.controlState.middlePressed=!0,this.controlState.middleDownScreenPosition=this.controlState.mousePosition,this.controlState.middleDownCanvasPosition=this.controlState.mousePosition.toCanvasCoords()):e.type==="mouseup"?e.button===0?this.controlState.leftPressed=!1:e.button===2?this.controlState.rightPressed=!1:e.button===1&&(this.controlState.middlePressed=!1):e.type==="keydown"?e.key&&(this.controlState.keys[e.key]=!0):e.type==="keyup"&&e.key&&(this.controlState.keys[e.key]=!1),this.interpretIntent()}interpretIntent(){let e=this.controlState.lastEvent;if(e){if(this.controlState.contextMenuContext){if(e.type==="click"||e.type==="dblclick"||e.type==="mouseup"){this.handleContextMenuSelection();return}else if(e.type==="contextmenu"&&this.handleContextMenuSelection())return}if(this.controlState.dependencyCreationContext){let t=this.controlState.dependencyCreationContext;if(e.type==="mousemove"){let n=this.presenter.getTask(this.controlState.target)??this.controlState.mousePosition.toCanvasCoords();t.firstTaskIsRequiredTask?this.presenter.updateArrow(t.ghostArrow,{target:n,isGhostArrow:!0}):this.presenter.updateArrow(t.ghostArrow,{source:n,isGhostArrow:!0})}else if(e.type==="click"&&e.button===0){let n=this.presenter.getTask(this.controlState.target);n&&(t.firstTaskIsRequiredTask?this.app.createDependency(t.firstTask,n):this.app.createDependency(n,t.firstTask)),this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}else if(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape"){this.presenter.removeArrow(t.ghostArrow),this.controlState.dependencyCreationContext=null,this.controlState.mouseIsHoldingDependencyArrow=!1;return}return}if(this.controlState.mouseIsHoldingCanvas){if(e.type==="mousemove"){let t=this.controlState.mouseMovement;this.presenter.panCanvas(t)}else e.type==="mouseup"&&e.button===2&&(this.controlState.mouseIsHoldingCanvas=!1);return}if(this.controlState.mouseIsHoldingSingleTask){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.leftDownCanvasPosition),s=this.controlState.taskHeldByMouseOriginalCanvasPosition.add(n);if(D>0&&!this.controlState.keys.Alt){let r=Math.round(s.x/D)*D,p=Math.round(s.y/D)*D,c=Math.abs(s.x-r),k=Math.abs(s.y-p);s=y.new(c<ee?r:s.x,k<ee?p:s.y)}this.controlState.taskHeldByMouseCurrentCanvasPosition=s,this.presenter.moveTask(this.controlState.taskHeldByMouse,s,!1)}else e.type==="mouseup"&&e.button===0?(this.controlState.taskHeldByMouse&&this.app.moveTasks([{task:this.controlState.taskHeldByMouse,position:this.controlState.taskHeldByMouseCurrentCanvasPosition}]),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null):(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskHeldByMouse&&this.presenter.moveTask(this.controlState.taskHeldByMouse,this.controlState.taskHeldByMouseOriginalCanvasPosition),this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null);return}if(this.controlState.mouseIsHoldingTaskGroup){if(e.type==="mousemove"){let n=this.controlState.mousePosition.toCanvasCoords().subtractCoords(this.controlState.taskGroupAnchorOriginalMouseCanvasPosition),o=this.controlState.taskGroupOriginalPositions.get(this.controlState.taskGroupAnchor),s=o.add(n);if(D>0&&!this.controlState.keys.Alt){let r=Math.round(s.x/D)*D,p=Math.round(s.y/D)*D,c=Math.abs(s.x-r),k=Math.abs(s.y-p);s=y.new(c<ee?r:s.x,k<ee?p:s.y)}n=s.subtractCoords(o),this.presenter.moveTask(this.controlState.taskGroupAnchor,s,!1),this.controlState.selectedTasks.forEach(r=>{if(r===this.controlState.taskGroupAnchor)return;let c=this.controlState.taskGroupOriginalPositions.get(r).add(n);this.presenter.moveTask(r,c,!1)})}else if(e.type==="mouseup"&&e.button===0){let t=[];this.controlState.selectedTasks.forEach(n=>{let o=this.presenter.getTaskPositionOnCanvas(n);t.push({task:n,position:o})}),this.app.moveTasks(t),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition}else(e.type==="contextmenu"&&e.button===2||e.type==="keydown"&&e.key==="Escape")&&(this.controlState.taskGroupOriginalPositions.forEach((t,n)=>{this.presenter.moveTask(n,t)}),this.controlState.mouseIsHoldingTaskGroup=!1,delete this.controlState.taskGroupOriginalPositions,delete this.controlState.taskGroupAnchor,delete this.controlState.taskGroupAnchorOriginalMouseCanvasPosition);return}if(this.controlState.mouseIsDrawingSelectionBox){if(e.type==="mousemove"){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition;this.presenter.moveSelectionBox(t,n)}else if(e.type==="mouseup"&&e.button===0){let t=this.controlState.selectionBoxStart,n=this.controlState.mousePosition,o=this.presenter.getTasksInArea(t,n),s=this.controlState.keys.Alt||this.controlState.keys.Meta;for(let r of o)s?this.deselectTask(r):this.selectTask(r);this.releaseSelectionBox()}else e.type==="contextmenu"&&e.button===2?this.releaseSelectionBox():e.type==="keydown"&&e.key==="Escape"&&this.releaseSelectionBox();return}if(this.controlState.taskTitleEditContext){let t=this.controlState.taskTitleEditContext,n=()=>{let o=this.presenter.getTaskTitle(t.task);this.presenter.toggleEditModeForTaskTitle(t.task,!1),o&&o.length>0?this.app.changeTaskTitle(t.task,o):this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null};if(e.type==="keydown"&&e.key==="Enter"){n();return}if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let o=this.presenter.getTaskInfo(this.controlState.target);if(o?.task===t.task&&o.component==="title")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskTitle(t.task,!1),this.presenter.setTaskTitle(t.task,t.originalTitle),this.controlState.taskTitleEditContext=null;return}}if(this.controlState.taskDescriptionEditContext){let t=this.controlState.taskDescriptionEditContext,n=()=>{let o=this.presenter.getTaskDescription(t.task);this.presenter.toggleEditModeForTaskDescription(t.task,!1),o&&o.length>0?this.app.changeTaskDescription(t.task,o):this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null};if(e.type==="mousedown"||e.type==="click"||e.type==="dblclick"||e.type==="contextmenu"){let o=this.presenter.getTaskInfo(this.controlState.target);if(o?.task===t.task&&o.component==="description")return;n()}else if(e.type==="keydown"&&e.key==="Escape"){this.presenter.toggleEditModeForTaskDescription(t.task,!1),this.presenter.setTaskDescription(t.task,t.originalDescription),this.controlState.taskDescriptionEditContext=null;return}}if(e.type==="mousedown"){if(e.button===0){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n){let o=this.controlState.selectedTasks.has(n);if(!o&&this.controlState.keys.Shift&&(this.selectTask(n),o=!0),o){this.tryGrabTaskGroup(n);return}else{this.tryGrabSingleTask(n);return}}else if(this.tryGrabSelectionBox()){this.controlState.keys.Shift||this.deselectAllTasks();return}}else if(e.button===2){this.tryGrabCanvas();return}return}if((e.type==="click"||e.type==="dblclick")&&e.button===0){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n&&this.controlState.keys.Shift){this.controlState.selectedTasks.has(n)?this.deselectTask(n):this.selectTask(n);return}if(this.deselectAllTasks(),n){if(e.type==="dblclick"&&t.component==="header"){this.app.toggleTaskExpansion(n,null);return}if(t.component==="title"){let o=t.task.getTitle();this.presenter.toggleEditModeForTaskTitle(n,!0),this.controlState.taskTitleEditContext={task:n,originalTitle:o};return}if(t.component==="description"){let o=t.task.getDescription();this.presenter.toggleEditModeForTaskDescription(n,!0),this.controlState.taskDescriptionEditContext={task:n,originalDescription:o};return}if(t.component==="collapse"){this.app.toggleTaskExpansion(n,null);return}if(t.component==="completion"){this.app.toggleTaskCompletion(n,null);return}if(e.type==="click"){this.selectTask(n);return}}else if(e.type==="dblclick"){let o=this.controlState.mousePosition.toCanvasCoords(),s=y.new(Math.floor(o.x/D)*D,Math.floor(o.y/D)*D);this.app.createTask(s);return}return}if(e.type==="contextmenu"){let t=this.presenter.getTaskInfo(this.controlState.target),n=t?t.task:null;if(n){let s=[["REQUIRES_DEPENDENCY","Requires Dependency"],["REQUIRED_BY_DEPENDENCY","Required By Dependency"]];this.controlState.selectedTasks.has(n)?s.unshift(["DELETE_SELECTED_TASKS","Delete Selected Tasks"]):s.unshift(["DELETE_TASK","Delete Task"]),this.presenter.showContextMenu(this.controlState.mousePosition,s),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,task:n};return}let o=this.presenter.getDependency(this.controlState.target);if(o){this.presenter.showContextMenu(this.controlState.mousePosition,[["DELETE_DEPENDENCY","Delete Dependency"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition,dependency:o};return}else{this.presenter.showContextMenu(this.controlState.mousePosition,[["ADD_TASK","Add Task"]]),this.controlState.contextMenuContext={target:this.controlState.target,position:this.controlState.mousePosition};return}}if(e.type==="keydown"){if(this.controlState.keys.a&&(this.controlState.keys.Control||this.controlState.keys.Meta)){this.selectAllTasks();return}if(this.controlState.keys.Delete||this.controlState.keys.Backspace){let t=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(t);return}return}}}handleContextMenuSelection(){if(this.controlState.contextMenuContext===null)return!1;let e=this.controlState.contextMenuContext,t=this.presenter.getContextMenuOption(this.controlState.target);if(t==="ADD_TASK"){let n=e.position.toCanvasCoords();this.app.createTask(n)}else if(t==="DELETE_TASK")e.task&&(this.controlState.selectedTasks.delete(e.task),this.app.deleteTasks([e.task]));else if(t==="DELETE_SELECTED_TASKS"){let n=Array.from(this.controlState.selectedTasks);this.controlState.selectedTasks.clear(),this.app.deleteTasks(n)}else if(t==="REQUIRES_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!1)}else if(t==="REQUIRED_BY_DEPENDENCY"){if(!e.task)throw new Error("Task is null");this.tryGrabDependencyArrow(e.task,!0)}else if(t==="DELETE_DEPENDENCY"){if(!e.dependency)throw new Error("Dependency is null");this.app.deleteDependency(e.dependency)}return this.controlState.contextMenuContext=null,this.presenter.hideContextMenu(),t!=null}mouseIsHoldingSomething(){return this.controlState.mouseIsHoldingSingleTask||this.controlState.mouseIsHoldingTaskGroup||this.controlState.mouseIsHoldingCanvas||this.controlState.mouseIsHoldingDependencyArrow||this.controlState.mouseIsDrawingSelectionBox}releaseAllMouseHolds(){this.controlState.mouseIsHoldingDependencyArrow&&(this.controlState.mouseIsHoldingDependencyArrow=!1),this.controlState.mouseIsHoldingSingleTask&&(this.controlState.mouseIsHoldingSingleTask=!1,this.controlState.taskHeldByMouse=null),this.controlState.mouseIsHoldingTaskGroup&&(this.controlState.mouseIsHoldingTaskGroup=!1),this.controlState.mouseIsHoldingCanvas&&(this.controlState.mouseIsHoldingCanvas=!1),this.controlState.mouseIsDrawingSelectionBox&&this.releaseSelectionBox()}tryGrabSingleTask(e){return this.controlState.mouseIsHoldingSingleTask&&this.controlState.taskHeldByMouse===e?!0:this.mouseIsHoldingSomething()?!1:(this.controlState.mouseIsHoldingSingleTask=!0,this.controlState.taskHeldByMouse=e,this.controlState.taskHeldByMouseOriginalCanvasPosition=this.presenter.getTaskPositionOnCanvas(e),this.presenter.adjustTaskZPosition(e,y.zero),!0)}tryGrabTaskGroup(e){return this.controlState.mouseIsHoldingTaskGroup?!0:this.mouseIsHoldingSomething()||this.controlState.selectedTasks.size===0?!1:(this.controlState.mouseIsHoldingTaskGroup=!0,this.controlState.taskGroupAnchor=e,this.presenter.adjustTaskZPosition(e,y.zero),this.controlState.taskGroupOriginalPositions=new Map,this.controlState.selectedTasks.forEach(t=>{this.controlState.taskGroupOriginalPositions.set(t,this.presenter.getTaskPositionOnCanvas(t))}),this.controlState.taskGroupAnchorOriginalMouseCanvasPosition=this.controlState.mousePosition.toCanvasCoords(),!0)}tryGrabCanvas(){return this.controlState.mouseIsHoldingCanvas?!0:this.mouseIsHoldingSomething()?!1:(this.controlState.mouseIsHoldingCanvas=!0,!0)}tryGrabDependencyArrow(e,t){if(this.controlState.mouseIsHoldingDependencyArrow)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsHoldingDependencyArrow=!0;let n=this.controlState.mousePosition.toCanvasCoords(),o=t?e:n,s=t?n:e,r=this.presenter.createArrow(o,s);return this.controlState.dependencyCreationContext={firstTask:e,firstTaskIsRequiredTask:t,ghostArrow:r},!0}tryGrabSelectionBox(){if(this.controlState.mouseIsDrawingSelectionBox)return!0;if(this.mouseIsHoldingSomething())return!1;this.controlState.mouseIsDrawingSelectionBox=!0,this.controlState.selectionBoxStart=this.controlState.mousePosition;let e=this.controlState.selectionBoxStart,t=this.controlState.mousePosition;return this.presenter.moveSelectionBox(e,t),this.presenter.showSelectionBox(),!0}releaseSelectionBox(){this.presenter.hideSelectionBox(),this.controlState.mouseIsDrawingSelectionBox=!1}selectTask(e){this.controlState.selectedTasks.add(e),this.presenter.toggleTaskHighlight(e,!0)}selectAllTasks(){let e=this.presenter.getAllTasks();this.controlState.selectedTasks=new Set(e),this.presenter.toggleAllTaskHighlights(!0)}deselectTask(e){this.controlState.selectedTasks.delete(e),this.presenter.toggleTaskHighlight(e,!1)}deselectAllTasks(){this.controlState.selectedTasks.clear(),this.presenter.toggleAllTaskHighlights(!1)}};var le=function(){let i=0,e=20,t=10,n=10,o=2;function s(a,d){return a instanceof I?d==="start"?a.position.translate(a.size.x,20):a.position.translate(0,20):a}function r(a,d,u){let v=(a+d)/2;return Math.round(v/u)*u}function p(a,d,u,v,b){let l;if(a.x<=d.x&&d.x-a.x>=2*10){let m=a.x+10,C=d.x-10,f=Math.ceil(m/u)*u,w=Math.floor(C/u)*u;if(f<w){let S=r(f,w,u);l=[a,new g(f,a.y),new g(S,a.y),new g(S,d.y),new g(w,d.y),d]}else f===w&&(l=[a,new g(f,a.y),new g(f,d.y),d])}if(!l){let m=Math.ceil((a.x+10)/u)*u,C=Math.floor((d.x-10)/u)*u,f=v instanceof I?v.bottom:a.y,w=b instanceof I?b.top:d.y,S=Math.round((f+w)/2/u)*u;l=[a,new g(m,a.y),new g(m,S),new g(C,S),new g(C,d.y),d]}if(l.length>0){let m=l[l.length-1];m.x===d.x&&(l[l.length-1]=m.translate(-o,0))}return l}function c(a,d){let u=a.map(C=>C.x),v=a.map(C=>C.y),b=Math.min(...u),h=Math.min(...v),l=Math.max(...u),m=Math.max(...v);return new I(new g(b-d,h-d),new g(l-b+2*d,m-h+2*d))}function k(a){if(!a.length)return a;let d=[a[0]];for(let u=1;u<a.length;u++){let v=d[d.length-1];(a[u].x!==v.x||a[u].y!==v.y)&&d.push(a[u])}return d}function A(a,d){if(a=k(a),a.length===0)return"";if(a.length===1)return`M ${a[0].x},${a[0].y}`;if(a.length===2)return`M ${a[0].x},${a[0].y} L ${a[1].x},${a[1].y}`;let u=`M ${a[0].x},${a[0].y}`,v=a[0],b=[a[0]];for(let l=1;l<a.length-1;l++){let m=a[l],C=a[l+1],f=m.sub(v),w=C.sub(m);if(f.x===0&&w.x===0||f.y===0&&w.y===0){b.push(m),v=m;continue}let S=f.normalize(),T=w.normalize(),F=S.negate().dot(T),L=Math.min(1,Math.max(-1,F)),R=Math.acos(L);if(R===0){b.push(m),v=m;continue}let N=d/Math.tan(R/2),re=Math.sqrt(f.lenSqr()),E=Math.sqrt(w.lenSqr()),U=Math.min(N,re,E),P=U*Math.tan(R/2),z=m.sub(S.mul(U)),V=m.add(T.mul(U));b.push(z),b.push({arc:!0,center:m,from:z,to:V,r:P,u1:S,u2:T,theta:R}),b.push(V),v=V}b.push(a[a.length-1]);let h=b[0];u=`M ${h.x},${h.y}`;for(let l=1;l<b.length;l++){let m=b[l];if(m.arc)continue;let C=m;if(l<b.length-1&&b[l+1].arc){u+=` L ${C.x},${C.y}`;let f=b[l+1],S=f.u1.x*f.u2.y-f.u1.y*f.u2.x<0?0:1;u+=` A ${f.r},${f.r} 0 0,${S} ${f.to.x},${f.to.y}`,l+=2}else u+=` L ${C.x},${C.y}`}return u}return{createArrow:function(a,d,u,v={}){v=v||{};let b=v.gridSize||e,h=t;i++;let l="http://www.w3.org/2000/svg",m=s(d,"start"),C=s(u,"end"),f=!1;d instanceof I&&d.contains(C)&&(f=!0),u instanceof I&&u.contains(m)&&(f=!0);let w=p(m,C,b,d,u);w||(f=!0);let S=c(w||[m,C],h),T=document.createElementNS(l,"svg");T.style.position="absolute",T.style.left=S.left+"px",T.style.top=S.top+"px",T.style.width=S.width+"px",T.style.height=S.height+"px",T.style.overflow="visible",T.style.pointerEvents="none",T.dataset.role="dependency-arrow",a.appendChild(T),v.dataId&&(T.dataset.id=v.dataId);let oe="arrowhead-"+i,F=document.createElementNS(l,"defs"),L=document.createElementNS(l,"marker");L.setAttribute("id",oe),L.setAttribute("markerWidth","6"),L.setAttribute("markerHeight","6"),L.setAttribute("refX","5"),L.setAttribute("refY","3"),L.setAttribute("orient","auto"),L.setAttribute("viewBox","0 0 6 6");let R=document.createElementNS(l,"path");R.setAttribute("d","M0,0 L6,3 L0,6 L1.5,3 z"),R.setAttribute("fill",v.color||"white"),R.style.pointerEvents="visiblePainted",L.appendChild(R),F.appendChild(L),T.appendChild(F);let N;w?N=w.map(P=>P.sub(S.position)):N=[m.sub(S.position),C.sub(S.position)];let re=A(N,n),E=document.createElementNS(l,"path");return E.setAttribute("d",re),E.setAttribute("fill","none"),E.setAttribute("stroke",v.color||"white"),E.setAttribute("stroke-width",o.toString()),E.setAttribute("marker-end",`url(#${oe})`),E.style.pointerEvents="visiblePainted",f&&(E.style.display="none"),T.appendChild(E),{svg:T,update:function(P,z){let V=s(P,"start"),j=s(z,"end"),W=!1;P instanceof I&&P.contains(j)&&(W=!0),z instanceof I&&z.contains(V)&&(W=!0);let Z=p(V,j,b,P,z);Z||(W=!0);let K=c(Z||[V,j],h);T.style.left=K.left+"px",T.style.top=K.top+"px",T.style.width=K.width+"px",T.style.height=K.height+"px";let ce=Z?Z.map(ue=>ue.sub(K.position)):[V.sub(K.position),j.sub(K.position)],de=A(ce,n);E.setAttribute("d",de),E.style.display=W?"none":"block"},remove:function(){T.parentNode&&T.parentNode.removeChild(T)},addEventListener:function(P,z,V){E.addEventListener(P,z,V)},setColor:function(P){E.setAttribute("stroke",P),R.setAttribute("fill",P)}}}}}();var ne=class{constructor(){this.orderedTasks=[];this.canvas=null;this.didInit=!1;this.selectionBoxElement=null;this.contextMenuElement=null;this.taskMap=new Map;this.dependencyMap=new Map;this.didInit||(this.canvas=document.getElementById("canvas"),x.init(this.canvas),this.contextMenuElement=document.getElementById("contextMenu"),this.contextMenuElement||(this.contextMenuElement=document.createElement("div"),this.contextMenuElement.id="contextMenu",this.contextMenuElement.style.position="absolute",this.contextMenuElement.style.display="none",document.body.appendChild(this.contextMenuElement)),this.didInit=!0)}panCanvas(e){x.panBy(e.vec)}getTaskPositionOnCanvas(e){let t=this.getTaskElement(e);if(!t)throw new Error("Task element not found");return y.new(t.offsetLeft,t.offsetTop)}toggleTaskHighlight(e,t){let n=this.getTaskElement(e);n&&(t?n.classList.add("selected"):n.classList.remove("selected"))}toggleAllTaskHighlights(e){(this.canvas?.querySelectorAll(".task")).forEach(n=>{e?n.classList.add("selected"):n.classList.remove("selected")})}showSelectionBox(){if(!this.canvas)throw new Error("Canvas not initialized");this.selectionBoxElement||(this.selectionBoxElement=document.createElement("div"),this.selectionBoxElement.style.position="absolute",this.selectionBoxElement.style.border="1px dashed lightblue",this.selectionBoxElement.style.backgroundColor="rgba(173,216,230,0.2)",this.selectionBoxElement.style.pointerEvents="none",this.canvas.appendChild(this.selectionBoxElement))}moveSelectionBox(e,t){if(!this.selectionBoxElement)return;let n=Math.min(e.x,t.x),o=Math.min(e.y,t.y),s=x.getScale(),r=x.getTranslation();n=(n-r.x)/s,o=(o-r.y)/s;let p=Math.abs(e.x-t.x)/s,c=Math.abs(e.y-t.y)/s;this.selectionBoxElement.style.left=n+"px",this.selectionBoxElement.style.top=o+"px",this.selectionBoxElement.style.width=p+"px",this.selectionBoxElement.style.height=c+"px"}hideSelectionBox(){this.selectionBoxElement&&(this.selectionBoxElement.remove(),this.selectionBoxElement=null)}getAllTasks(){return Array.from(this.taskMap.values()).map(e=>e.task)}getTasksInArea(e,t){if(!this.canvas)throw new Error("Canvas not initialized");let n=G.fromPoints(e,t),o=[];return this.canvas.querySelectorAll(".task").forEach(r=>{let p=G.fromElementBounds(r);if(n.intersects(p)){let c=r.getAttribute("data-id");c&&this.taskMap.has(c)&&o.push(this.taskMap.get(c).task)}}),o}showContextMenu(e,t){let n=this.contextMenuElement;if(!n)throw new Error("Not initialized");n.innerHTML="",t.forEach(o=>{let s=document.createElement("div");s.textContent=o[1],s.setAttribute("data-role","context-menu-item"),s.setAttribute("data-key",o[0]),n.appendChild(s)}),n.style.left=e.x+"px",n.style.top=e.y+"px",n.style.display="block"}hideContextMenu(){this.contextMenuElement&&(this.contextMenuElement.style.display="none")}addTaskToCanvas(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=document.createElement("div");t.classList.add("task"),t.setAttribute("data-id",e.getId());let n=e.getPosition();n&&(t.style.left=n.x+"px",t.style.top=n.y+"px",t.setAttribute("data-snapped",n.x%40===0&&n.y%40===0?"true":"false"));let o=document.createElement("div");o.classList.add("task-header");let s=document.createElement("div");s.classList.add("toggle"),s.setAttribute("data-role","toggle"),s.textContent=e.isExpanded()?"\u25BC":"\u25BA",o.appendChild(s);let r=document.createElement("div");r.classList.add("title"),r.setAttribute("data-role","title"),r.textContent=e.getTitle(),o.appendChild(r);let p=document.createElement("div");p.classList.add("custom-checkbox"),p.setAttribute("data-role","checkbox");let c=document.createElement("div");c.classList.add("checkbox-fill"),c.innerHTML=`
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" style="background: transparent;">
  <rect x="1" y="1" width="26" height="26" rx="3.75" ry="3.75" fill="none" stroke="#4d4d4d" stroke-width="2"></rect>
  <defs>
    <mask id="checkMask-${e.getId()}">
      <rect x="0" y="0" width="28" height="28" fill="white"></rect>
      <polyline points="8,15 12,19 20,9" stroke="black" stroke-width="2" stroke-linecap="round" fill="none" stroke-linejoin="round"></polyline>
    </mask>
  </defs>
  <rect x="4" y="4" width="20" height="20" rx="1.9" ry="1.9" fill="#25a599" fill-opacity="${e.isComplete()?"1":"0.1"}" mask="url(#checkMask-${e.getId()})"></rect>
</svg>`,p.appendChild(c),o.appendChild(p),t.appendChild(o);let k=document.createElement("div");k.classList.add("task-body"),t.appendChild(k);let A=document.createElement("div");A.classList.add("description"),A.setAttribute("data-role","description"),A.innerHTML=e.getDescription(),k.appendChild(A),n&&this.adjustTaskZPositionInternal(t,n),this.taskMap.set(e.getId(),{task:e,element:t})}moveTask(e,t,n=!0){let o=this.taskMap.get(e.getId());if(!o)return;let s=o.element;s.style.left=t.x+"px",s.style.top=t.y+"px",n&&this.adjustTaskZPositionInternal(s,t)}adjustTaskZPosition(e,t){let n=this.taskMap.get(e.getId());n&&this.adjustTaskZPositionInternal(n.element,t)}adjustTaskZPositionInternal(e,t){let n=this.orderedTasks.find(s=>s.element===e);n?(n.position=t,this.orderedTasks=this.orderedTasks.filter(s=>s.element!==e)):n={id:e.getAttribute("data-id")||"",element:e,position:t};let o=this.orderedTasks.findIndex(s=>t.y>s.position.y||t.y===s.position.y&&t.x>s.position.x);if(o===-1&&(o=this.orderedTasks.length),this.orderedTasks.splice(o,0,n),!this.canvas)throw new Error("Canvas not initialized");o===this.orderedTasks.length-1?this.canvas.appendChild(e):this.canvas.insertBefore(e,this.orderedTasks[o+1].element)}toggleEditModeForTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let s=n.element.querySelector('[data-role="title"]'),r=s instanceof HTMLInputElement?s:null;if(t)r||(r=document.createElement("input"),r.dataset.role="title",r.type="text",r.value=s.textContent||"",r.style.width="100%",s.replaceWith(r),r.focus());else if(r){let p=document.createElement("div");p.dataset.role="title",p.classList.add("title"),p.textContent=r.value,r.replaceWith(p)}}getTaskTitle(e){let t=this.taskMap.get(e.getId());if(!t)return"";let o=t.element.querySelector('[data-role="title"]'),s=o instanceof HTMLInputElement?o:null;return s?s.value:o.textContent||""}setTaskTitle(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let s=n.element.querySelector('[data-role="title"]'),r=s instanceof HTMLInputElement?s:null;r?r.value=t:s.textContent=t}toggleEditModeForTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let s=n.element.querySelector('[data-role="description"], .editor-container');if(t){if(s&&s.classList.contains("editor-container"))return;let r=s?s.innerHTML:"",p=document.createElement("div");p.classList.add("editor-container"),p.style.minHeight="50px";let c=document.createElement("div");p.appendChild(c),s&&s.parentNode&&s.parentNode.replaceChild(p,s);let k=new Quill(c,{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{color:[]},{background:[]}],[{align:[]}],["clean"]]}});k.root.innerHTML=r,k.focus(),setTimeout(()=>k.setSelection(k.getLength(),0),0);let A=()=>{let a=k.root.scrollHeight;c.style.height=a+"px"};k.on("text-change",A),A(),p._quill=k}else{if(!s||!s.classList.contains("editor-container"))return;let r=s._quill;if(!r)return;let p=r.root.innerHTML,c=document.createElement("div");c.classList.add("description"),c.setAttribute("data-role","description"),c.innerHTML=p,s.parentNode?.replaceChild(c,s)}}getTaskDescription(e){let t=this.taskMap.get(e.getId());if(!t)return null;let o=t.element.querySelector('[data-role="description"], .editor-container');if(!o)return null;if(o.classList.contains("editor-container")){let s=o._quill;return s?s.root.innerHTML:null}else return o.innerHTML}setTaskDescription(e,t){let n=this.taskMap.get(e.getId());if(!n)return;let s=n.element.querySelector('[data-role="description"], .editor-container');if(s)if(s.classList.contains("editor-container")){let r=s._quill;r&&(r.root.innerHTML=t)}else s.innerHTML=t}toggleTaskCompletion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let o=n.querySelector(".checkbox-fill");if(o){let s=o.querySelector("rect[mask]");s&&s.setAttribute("fill-opacity",t?"1":"0.1")}}toggleTaskExpansion(e,t){let n=this.getTaskElement(e);if(!n)throw new Error("Task element not found");let o=n.querySelector(".task-body");o&&(o.style.display=t?"none":"block");let s=n.querySelector(".toggle");s&&(s.textContent=t?"\u25BA":"\u25BC")}removeTask(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=this.taskMap.get(e.getId());t&&(t.element.remove(),this.taskMap.delete(e.getId()));let n=this.orderedTasks.findIndex(o=>o.id===e.getId());n!==-1&&this.orderedTasks.splice(n,1)}addDependency(e){if(!this.canvas)throw new Error("Canvas not initialized");let t=e.getRequiredTask(),n=e.getRequiredByTask(),o=this.dependencyKey(t.getId(),n.getId()),s=new X(this,t,n,e,o,this.canvas);return this.dependencyMap.set(o,s),s}removeDependency(e){let t=this.dependencyKey(e.getRequiredTask().getId(),e.getRequiredByTask().getId()),n=this.dependencyMap.get(t);n&&(n.remove(),this.dependencyMap.delete(t))}createArrow(e,t){if(!this.canvas)throw new Error("Canvas not initialized");return new X(this,e,t,null,null,this.canvas)}updateArrow(e,t){if(!(e instanceof X))throw new Error("Invalid arrow");let n=e;if(n.update(t?.source||null,t?.target||null),t?.isGhostArrow){let o=t.source?t.source:n.getSource(),s=t.target?t.target:n.getTarget(),k=o instanceof y||s instanceof y?"#b3555588":"#55b38888";n.setColor(k)}else n.setColor(X.defaultColor)}removeArrow(e){e.remove()}getTaskInfo(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id");if(!n||!this.taskMap.has(n))return null;let o=this.taskMap.get(n).task;return e.closest('[data-role="title"]')?{task:o,component:"title"}:e.closest('[data-role="description"]')?{task:o,component:"description"}:e.closest('[data-role="toggle"]')?{task:o,component:"collapse"}:e.closest('[data-role="checkbox"]')?{task:o,component:"completion"}:e.closest(".task-header")?{task:o,component:"header"}:{task:o,component:"task"}}getTask(e){let t=this.getTaskElementFromChild(e);if(!t)return null;let n=t.getAttribute("data-id");return n?this.taskMap.get(n).task:null}getDependency(e){let t=e.closest('[data-role="dependency-arrow"]');if(!t)return null;let n=t.getAttribute("data-id");return n&&this.dependencyMap.get(n)?.dependency||null}getContextMenuOption(e){if(!e)return null;let t=e.closest('[data-role="context-menu-item"]');return t?t.getAttribute("data-key"):null}getTaskElement(e){let t=this.taskMap.get(e.getId());return t?t.element:null}getTaskElementFromChild(e){return e.closest(".task")}dependencyKey(e,t){return e+"->"+t}},X=class i{constructor(e,t,n,o,s,r){this.presenter=e;this.dependency=o;this.source=this.setSource(t),this.target=this.setTarget(n),this.arrow=le.createArrow(r,this.getArrowSource(),this.getArrowTarget(),{color:i.defaultColor,dataId:s||void 0}),r.prepend(this.arrow.svg)}static{this.defaultColor="#b3b3b3"}getSource(){return this.source instanceof y?this.source:this.source.task}setSource(e){if(e instanceof y)this.source=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid source");this.source=new se(e,t)}return this.source}getArrowSource(){if(this.source instanceof y)return this.source.vec;if(this.source.element)return G.fromElementBounds(this.source.element).toCanvasRect().rect;throw new Error("Invalid source")}getTarget(){return this.target instanceof y?this.target:this.target.task}setTarget(e){if(e instanceof y)this.target=e;else{let t=this.presenter.getTaskElement(e)||void 0;if(!t)throw new Error("Invalid target");this.target=new se(e,t)}return this.target}getArrowTarget(){if(this.target instanceof y)return this.target.vec;if(this.target.element)return G.fromElementBounds(this.target.element).toCanvasRect().rect;throw new Error("Invalid target")}update(e,t){e&&this.setSource(e),t&&this.setTarget(t);let n=this.getArrowSource(),o=this.getArrowTarget();this.arrow.update(n,o)}setColor(e){this.arrow.setColor(e)}remove(){this.arrow.remove()}},se=class{constructor(e,t){this.task=e;this.element=t}};document.addEventListener("DOMContentLoaded",()=>{let i=new ne,e=new _(i),t=new te(e,i)});})();
//# sourceMappingURL=app.js.map
