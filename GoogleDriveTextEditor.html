<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Google Drive Text Editor</title>
    <!-- Load the Google API client library (for Drive & Picker) -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Load the new Google Identity Services library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      // Your actual credentials
      const CLIENT_ID = '834406545740-fpa6k2omak75t15u8ve4t7n0t3r1r0ig.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCMJf3NuTEBASgWaXTQhy6fiM9QY0GAitg';

      // Discovery docs and scopes for Google Drive API.
      const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
      const SCOPES = 'https://www.googleapis.com/auth/drive';

      let tokenClient;
      let accessToken = null;
      let currentFileId = null; // ID of the currently loaded file.
      let textArea;

      // Initialize the GAPI client and token client.
      function handleClientLoad() {
        // Load the Drive API client.
        gapi.load('client', initGapiClient);
        // Initialize the token client via Google Identity Services.
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (response) => {
            if (response.error) {
              console.error(response);
              return;
            }
            accessToken = response.access_token;
            console.log("Access token acquired:", accessToken);
            // After sign-in, if no file is loaded, prompt the user.
            if (!currentFileId) {
              setTimeout(initialPrompt, 100);
            }
          }
        });
      }

      function initGapiClient() {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS
        }).then(() => {
          console.log("GAPI client initialized.");
        }, (error) => {
          console.error("Error initializing GAPI client:", error);
        });
      }

      // Trigger sign-in.
      function handleAuthClick() {
        tokenClient.requestAccessToken();
      }

      // Sign out: revoke token and clear UI state.
      function handleSignoutClick() {
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken, () => {
            console.log("Token revoked.");
          });
        }
        accessToken = null;
        currentFileId = null;
        textArea.value = '';
        console.log("Signed out.");
      }

      // INITIAL PROMPT: Ask the user on sign-in whether to open a file or create a new one.
      function initialPrompt() {
        if (confirm("Would you like to open an existing file?\n\nClick OK to open a file, or Cancel to create a new one.")) {
          openFilePicker();
        } else {
          if (confirm("Do you want to choose a folder for your new file?\n\nClick OK to pick a folder, or Cancel to use the root folder.")) {
            openFolderPickerForNewFile();
          } else {
            const fileName = prompt("Enter the file name for the new file (e.g., myfile.txt):");
            if (fileName) {
              createNewFile(fileName, 'root');
            }
          }
        }
      }

      // Open file picker: shows a view for text files in the root directory, plus a folder view for navigation.
      function openFilePicker() {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        gapi.load('picker', function() {
          // File view: shows only text files.
          const fileView = new google.picker.DocsView(google.picker.ViewId.DOCS)
            .setIncludeFolders(true)
            .setParent('root')
            .setMode(google.picker.DocsViewMode.LIST)
            .setMimeTypes("text/plain");

          const picker = new google.picker.PickerBuilder()
            .addView(fileView)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(filePickerCallback)
            .build();
          picker.setVisible(true);
        });
      }

      // Callback for file picker.
      function filePickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const fileId = data.docs[0].id;
          loadFile(fileId);
        }
      }

      // Open folder picker for "Save As" functionality.
      function openFolderPicker() {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        gapi.load('picker', function() {
          const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setParent('root')
            .setMode(google.picker.DocsViewMode.LIST)
            .setSelectFolderEnabled(true);
          const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(folderPickerCallback)
            .build();
          picker.setVisible(true);
        });
      }

      // Callback for folder picker used in "Save As".
      function folderPickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const folderId = data.docs[0].id;
          const fileName = prompt("Enter the file name to save (e.g., myfile.txt):");
          if (fileName) {
            saveFileToFolder(fileName, folderId);
          }
        }
      }

      // Open folder picker specifically for new file creation.
      function openFolderPickerForNewFile() {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        gapi.load('picker', function() {
          const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setParent('root')
            .setMode(google.picker.DocsViewMode.LIST)
            .setSelectFolderEnabled(true);
          const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(folderPickerNewFileCallback)
            .build();
          picker.setVisible(true);
        });
      }

      // Callback for folder picker used when creating a new file.
      function folderPickerNewFileCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const folderId = data.docs[0].id;
          const fileName = prompt("Enter the file name for the new file (e.g., myfile.txt):");
          if (fileName) {
            createNewFile(fileName, folderId);
          }
        }
      }

      // Load a file's content into the text area.
      function loadFile(fileId) {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        gapi.client.drive.files.get({
          fileId: fileId,
          alt: 'media'
        }).then((response) => {
          textArea.value = response.body;
          currentFileId = fileId;
        }, (error) => {
          console.error("Error loading file:", error);
        });
      }

      // Update the currently loaded file.
      function saveFile() {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        if (!currentFileId) {
          alert("No file loaded. Use 'Save As' to create a new file.");
          return;
        }
        const content = textArea.value;
        fetch('https://www.googleapis.com/upload/drive/v3/files/' + currentFileId + '?uploadType=media', {
          method: 'PATCH',
          headers: new Headers({
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'text/plain'
          }),
          body: content
        })
        .then((res) => res.json())
        .then((result) => {
          alert('File updated successfully!');
        });
      }

      // Create a new file with the given name in the specified folder.
      function createNewFile(fileName, folderId) {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        const content = textArea.value;
        const file = new Blob([content], {type: 'text/plain'});
        let metadata = {
          name: fileName,
          mimeType: 'text/plain'
        };
        if (folderId !== 'root') {
          metadata.parents = [folderId];
        }
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);

        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
          body: form
        })
        .then((res) => res.json())
        .then((result) => {
          currentFileId = result.id;
          alert('New file created with ID: ' + result.id);
        });
      }

      // "Save As": choose a destination folder and then save the file.
      function saveFileToFolder(fileName, folderId) {
        if (!accessToken) {
          console.error("No access token; please sign in.");
          return;
        }
        const content = textArea.value;
        const file = new Blob([content], {type: 'text/plain'});
        const metadata = {
          name: fileName,
          mimeType: 'text/plain',
          parents: [folderId]
        };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);

        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
          body: form
        })
        .then((res) => res.json())
        .then((result) => {
          currentFileId = result.id;
          alert('File saved with ID: ' + result.id);
        });
      }
    </script>
  </head>
  <body onload="handleClientLoad()">
    <h1>Google Drive Text Editor</h1>
    <button id="authorize_button" onclick="handleAuthClick()">Sign In with Google</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
    <br><br>
    <!-- These buttons are still available if you need them later -->
    <button onclick="openFilePicker()">Open File</button>
    <button onclick="saveFile()">Save File</button>
    <button onclick="openFolderPicker()">Save As</button>
    <br><br>
    <textarea id="editor" style="width:100%; height:300px;" placeholder="Edit your text here..."></textarea>
    <script>
      textArea = document.getElementById('editor');
    </script>
  </body>
</html>
